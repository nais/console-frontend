<script lang="ts">
	import { graphql, TeamOrderField } from '$houdini';
	import type { OrderDirection$options, TeamOrderField$options } from '$houdini';
	import {
		BodyLong,
		Heading,
		Loader,
		ToggleGroup,
		ToggleGroupItem
	} from '@nais/ds-svelte-community';
	import type { VulnerabilityLeadersVariables } from './$houdini';
	import EChart from '$lib/chart/EChart.svelte';
	import { changeParams } from '$lib/utils/searchparams';
	import type { EChartsOption } from 'echarts';
	import type { CallbackDataParams } from 'echarts/types/dist/shared';
	import { truncateString } from '$lib/chart/util';
	import { goto } from '$app/navigation';

	interface Props {
		mostVulnerableTeamsField: TeamOrderField$options;
		mostVulnerableTeamsDirection: OrderDirection$options;
	}

	let { mostVulnerableTeamsDirection, mostVulnerableTeamsField }: Props = $props();
	let showByToggle = $state() as TeamOrderField$options;
	showByToggle = mostVulnerableTeamsField || TeamOrderField.RISK_SCORE;

	export const _VulnerabilityLeadersVariables: VulnerabilityLeadersVariables = () => {
		return { mostVulnerableTeamsField, mostVulnerableTeamsDirection };
	};

	const vulnLeaders = $derived(
		graphql(`
			query VulnerabilityLeaders(
				$mostVulnerableTeamsField: TeamOrderField!
				$mostVulnerableTeamsDirection: OrderDirection!
			) @load {
				mostVulnerableTeams: teams(
					first: 20
					orderBy: { field: $mostVulnerableTeamsField, direction: $mostVulnerableTeamsDirection }
				) {
					nodes {
						slug
						workloads {
							pageInfo {
								totalCount
							}
						}
						vulnerabilitySummary {
							riskScore
							critical
							high
							medium
							low
							unassigned
							coverage
						}
					}
				}
			}
		`)
	);
	type VulnerabilityTeams =
		| {
				nodes: {
					slug: string;
					vulnerabilitySummary: {
						riskScore: number;
						critical: number;
						high: number;
						medium: number;
						low: number;
						unassigned: number;
						coverage: number;
					};
					workloads: {
						pageInfo: {
							totalCount: number;
						};
					};
				}[];
		  }
		| undefined
		| null;

	let mostVulnerable = $derived.by(() =>
		optionsMostVulnerable($vulnLeaders.data?.mostVulnerableTeams, showByToggle)
	);

	function optionsMostVulnerable(
		input: VulnerabilityTeams,
		showByToggle: TeamOrderField$options
	): EChartsOption {
		if (!input || input.nodes.length === 0) {
			return {} as EChartsOption;
		}

		const seriesData = input.nodes.map((s) =>
			showByToggle === TeamOrderField.RISK_SCORE
				? s.vulnerabilitySummary.riskScore
				: showByToggle === TeamOrderField.CRITICAL_VULNERABILITIES
					? s.vulnerabilitySummary.critical
					: s.vulnerabilitySummary.riskScore
		);

		return {
			height: '500px',
			tooltip: {
				trigger: 'axis',
				axisPointer: {
					type: 'line'
				},
				formatter: (params: CallbackDataParams[]) => {
					const items = params.map((p) => {
						return `
						<div>
							<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background:#ff4500;"></span>
							${p.seriesName}: ${p.value}
						</div>
					`;
					});
					return `${params[0].value}<br/>${items.join('')}`;
				}
			},
			xAxis: {
				type: 'category',
				data: input.nodes.map((s) => s.slug),
				axisLabel: {
					rotate: 60,
					formatter: (value: string) => truncateString(value, 23)
				}
			},
			legend: {
				show: false
			},
			yAxis: {
				type: 'value',
				name:
					showByToggle === TeamOrderField.RISK_SCORE
						? 'Risk Score'
						: showByToggle === TeamOrderField.CRITICAL_VULNERABILITIES
							? 'Critical Vulnerabilities'
							: 'Risk Score'
			},
			series: {
				name:
					showByToggle === TeamOrderField.RISK_SCORE
						? 'Risk Score'
						: showByToggle === TeamOrderField.CRITICAL_VULNERABILITIES
							? 'Critical Vulnerabilities'
							: 'Risk Score',
				type: 'bar',
				data: seriesData,
				color: '#ff4500', // Tooltip marker color (e.g. solid orange-red)
				itemStyle: {
					color: {
						type: 'linear',
						x: 0,
						y: 0,
						x2: 0,
						y2: 1,
						colorStops: [
							{ offset: 0, color: '#ff0000' }, // Red at top
							{ offset: 1, color: '#ffa500' } // Orange at bottom
						]
					}
				}
			}
		} as EChartsOption;
	}

	function handleChartClick(name: string) {
		goto(`/team/${name}/vulnerabilities`);
	}
</script>

<div>
	<Heading level="3" spacing
		>Most Vulnerable Teams - {showByToggle === TeamOrderField.RISK_SCORE
			? 'Highest Vulnerability Risk Score'
			: showByToggle === TeamOrderField.CRITICAL_VULNERABILITIES
				? 'Most Critical Vulnerabilities'
				: showByToggle === TeamOrderField.SBOM_COVERAGE
					? 'Lowest SBOM Coverage'
					: 'Should not print'}
	</Heading>
	<BodyLong>
		A ranked view of teams with the highest security risk, based on either overall Risk Score or the
		number of critical vulnerabilities. This chart helps teams identify and prioritize areas that
		require the most security attention.
	</BodyLong>
	<div class="toggles">
		<ToggleGroup
			size="small"
			label="Show by"
			value={showByToggle.toString()}
			onchange={(val) => {
				showByToggle = val as TeamOrderField$options;
				changeParams({ showByToggle }, { noScroll: true });
			}}
		>
			<ToggleGroupItem value={TeamOrderField.RISK_SCORE}>Risk Score</ToggleGroupItem>
			<ToggleGroupItem value={TeamOrderField.CRITICAL_VULNERABILITIES}
				>Critical Vulnerabilities</ToggleGroupItem
			>
		</ToggleGroup>
	</div>
	{#if !$vulnLeaders.fetching && $vulnLeaders.data}
		<EChart options={mostVulnerable} style="height: 700px" onclick={handleChartClick} />
	{:else}
		<div style="display: flex; justify-content: center; align-items: center; height: 500px;">
			<Loader size="3xlarge" />
		</div>
	{/if}
</div>

<style>
	.toggles {
		display: flex;
		gap: var(--spacing-layout);
		flex-direction: row;
		justify-content: flex-end;
	}
</style>
