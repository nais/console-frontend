<script lang="ts">
	import { page } from '$app/state';
	import { graphql } from '$houdini';
	import EChart from '$lib/chart/EChart.svelte';
	import { transformVulnerabilities } from '$lib/chart/transformVulnerabilities';
	import { changeParams } from '$lib/utils/searchparams';
	import { Loader, ToggleGroup, ToggleGroupItem } from '@nais/ds-svelte-community';
	import { subDays, subMonths } from 'date-fns';
	import type { ImageVulnerabilityHistoryVariables } from './$houdini';

	let riskScoreToggle = $state('off');
	let interval = $derived.by(() => {
		const val = page.url.searchParams.get('interval');
		if (val && ['6m', '30d', '7d'].includes(val)) return val;
		return '7d';
	});

	const getFrom = (interval: string): Date => {
		const now = new Date();
		switch (interval) {
			case '6m':
				return subMonths(now, 6);
			case '30d':
				return subDays(now, 30);
			case '7d':
				return subDays(now, 7);
			default:
				return subDays(now, 7);
		}
	};

	let from = $derived(getFrom(interval));

	export const _ImageVulnerabilityHistoryVariables: ImageVulnerabilityHistoryVariables = () => {
		return { from: from };
	};

	const vulnHistory = $derived(
		graphql(`
			query ImageVulnerabilityHistory($from: Date!) @load {
				imageVulnerabilityHistory(from: $from) {
					samples {
						date
						summary {
							critical
							high
							low
							medium
							unassigned
						}
					}
				}
			}
		`)
	);

	let options = $derived(
		transformVulnerabilities($vulnHistory.data?.imageVulnerabilityHistory, riskScoreToggle === 'on')
	);
</script>

<div class="toggles">
	<ToggleGroup
		size="small"
		label="Interval"
		value={interval}
		onchange={(interval) => changeParams({ interval }, { noScroll: true })}
	>
		{#each ['6m', '30d', '7d'] as interval (interval)}
			<ToggleGroupItem value={interval}>{interval}</ToggleGroupItem>
		{/each}
	</ToggleGroup>
	<ToggleGroup
		size="small"
		label="Risk score"
		value={riskScoreToggle}
		onchange={(val) => (riskScoreToggle = val)}
	>
		<ToggleGroupItem value="off">Off</ToggleGroupItem>
		<ToggleGroupItem value="on">On</ToggleGroupItem>
	</ToggleGroup>
</div>
{#if !$vulnHistory.fetching}
	{#key options}
		<EChart {options} style="height: 500px" />
	{/key}
{:else}
	<div style="display: flex; justify-content: center; align-items: center; height: 500px;">
		<Loader size="3xlarge" />
	</div>
{/if}

<style>
	.toggles {
		display: flex;
		gap: var(--spacing-layout);
		flex-direction: row;
		justify-content: flex-end;
	}
</style>
