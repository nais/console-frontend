<script lang="ts">
	import { graphql } from '$houdini';
	import EChart from '$lib/chart/EChart.svelte';
	import { transformVulnerabilities } from '$lib/chart/transformVulnerabilities';
	import {
		getFrom,
		intervalOptionsVulnerabilityHistory
	} from '$lib/components/vulnerability/dateUtils';
	import { Loader, ToggleGroup, ToggleGroupItem } from '@nais/ds-svelte-community';

	let riskScoreToggle = $state('off');
	let interval = $state('7d');

	let from = $derived(getFrom(interval));

	const vulnHistory = $derived(
		graphql(`
			query ImageVulnerabilityHistory($from: Date!) {
				imageVulnerabilityHistory(from: $from) {
					samples {
						date
						summary {
							critical
							high
							low
							medium
							unassigned
						}
					}
				}
			}
		`)
	);

	$effect.pre(() => {
		vulnHistory.fetch({
			variables: {
				from: from
			}
		});
	});

	let options = $derived(
		transformVulnerabilities($vulnHistory.data?.imageVulnerabilityHistory, riskScoreToggle === 'on')
	);
</script>

<div class="toggles">
	<ToggleGroup size="small" label="Interval" value={interval} onchange={(i) => (interval = i)}>
		{#each intervalOptionsVulnerabilityHistory as interval (interval)}
			<ToggleGroupItem value={interval}>{interval}</ToggleGroupItem>
		{/each}
	</ToggleGroup>
	<ToggleGroup
		size="small"
		label="Risk score"
		value={riskScoreToggle}
		onchange={(val) => (riskScoreToggle = val)}
	>
		<ToggleGroupItem value="off">Off</ToggleGroupItem>
		<ToggleGroupItem value="on">On</ToggleGroupItem>
	</ToggleGroup>
</div>
{#if !$vulnHistory.fetching}
	{#key options}
		<EChart {options} style="height: 500px" />
	{/key}
{:else}
	<div style="display: flex; justify-content: center; align-items: center; height: 500px;">
		<Loader size="3xlarge" />
	</div>
{/if}

<style>
	.toggles {
		display: flex;
		gap: var(--spacing-layout);
		flex-direction: row;
		justify-content: flex-end;
	}
</style>
