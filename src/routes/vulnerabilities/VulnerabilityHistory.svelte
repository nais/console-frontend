<script lang="ts">
	import { graphql } from '$houdini';
	import VulnerabilityChart from '$lib/chart/VulnerabilityChart.svelte';
	import {
		getFrom,
		intervalOptionsVulnerabilityHistory
	} from '$lib/components/vulnerability/dateUtils';
	import { Loader, ToggleGroup, ToggleGroupItem } from '@nais/ds-svelte-community';

	let interval: (typeof intervalOptionsVulnerabilityHistory)[number] = $state('7d');

	let from = $derived(getFrom(interval));

	const vulnHistory = $derived(
		graphql(`
			query ImageVulnerabilityHistory($from: Date!) {
				imageVulnerabilityHistory(from: $from) {
					samples {
						date
						summary {
							critical
							high
							low
							medium
							unassigned
						}
					}
				}
			}
		`)
	);

	$effect.pre(() => {
		vulnHistory.fetch({
			variables: {
				from: from
			}
		});
	});
</script>

<div class="toggles">
	<ToggleGroup
		size="small"
		label="Interval"
		value={interval}
		onchange={(i) => (interval = i as typeof interval)}
	>
		{#each intervalOptionsVulnerabilityHistory as interval (interval)}
			<ToggleGroupItem value={interval}>{interval}</ToggleGroupItem>
		{/each}
	</ToggleGroup>
</div>
{#if !$vulnHistory.fetching}
	<div>
		<VulnerabilityChart
			data={$vulnHistory.data?.imageVulnerabilityHistory}
			{interval}
			height="500px"
		/>
	</div>
{:else}
	<div style="display: flex; justify-content: center; align-items: center; height: 500px;">
		<Loader size="3xlarge" />
	</div>
{/if}

<style>
	.toggles {
		display: flex;
		gap: var(--spacing-layout);
		flex-direction: row;
		justify-content: flex-end;
	}
</style>
