<script lang="ts">
	import { graphql } from '$houdini';
	import VulnerabilityChart from '$lib/chart/VulnerabilityChart.svelte';
	import {
		getFromForVulnerabilityHistory,
		intervalOptionsVulnerabilityHistory
	} from '$lib/domain/vulnerability/dateUtils';
	import {
		BodyShort,
		Heading,
		Loader,
		ToggleGroup,
		ToggleGroupItem
	} from '@nais/ds-svelte-community';

	let interval: (typeof intervalOptionsVulnerabilityHistory)[number] = $state('7d');

	let from = $derived(getFromForVulnerabilityHistory(interval));

	const vulnHistory = $derived(
		graphql(`
			query ImageVulnerabilityHistory($from: Date!) {
				imageVulnerabilityHistory(from: $from) {
					samples {
						date
						summary {
							critical
							high
							low
							medium
							unassigned
						}
					}
				}
			}
		`)
	);

	$effect(() => {
		vulnHistory.fetch({
			variables: {
				from: from
			}
		});
	});
</script>

<div>
	<Heading level="2" as="h2" spacing>Vulnerability History</Heading>
	<BodyShort>
		Track vulnerability trends over time across all container images. This chart shows the
		distribution of vulnerabilities by severity level, helping you monitor your security posture and
		identify patterns in newly discovered issues.
	</BodyShort>
</div>

<div class="toggles">
	<ToggleGroup
		size="small"
		label="Interval"
		value={interval}
		onchange={(i) => (interval = i as typeof interval)}
	>
		{#each intervalOptionsVulnerabilityHistory as interval (interval)}
			<ToggleGroupItem value={interval}>{interval}</ToggleGroupItem>
		{/each}
	</ToggleGroup>
</div>
{#if !$vulnHistory.fetching}
	<div>
		<VulnerabilityChart
			data={$vulnHistory.data?.imageVulnerabilityHistory}
			{interval}
			height="400px"
		/>
	</div>
{:else}
	<div style="display: flex; justify-content: center; align-items: center; height: 500px;">
		<Loader size="3xlarge" />
	</div>
{/if}

<style>
	.toggles {
		display: flex;
		gap: var(--spacing-layout);
		flex-direction: row;
		justify-content: flex-end;
	}
</style>
