<script lang="ts">
	import ImageVulnerabilities from '$lib/components/image/ImageVulnerabilities.svelte';
	import VulnerabilityBadges from '$lib/components/VulnerabilityBadges.svelte';
	import { docURL } from '$lib/doc';
	import { envTagVariant } from '$lib/envTagVariant';
	import GraphErrors from '$lib/GraphErrors.svelte';
	import WarningIcon from '$lib/icons/WarningIcon.svelte';
	import { parseImage } from '$lib/utils/image';
	import { Detail, Heading, Tag } from '@nais/ds-svelte-community';
	import type { PageProps } from './$houdini';

	let { data }: PageProps = $props();

	let { JobImageDetails, viewerIsMember } = $derived(data);

	let registry: string = $state('');
	let repository: string = $state('');
	let name: string = $state('');

	$effect(() => {
		if ($JobImageDetails.data?.team.environment.workload.image) {
			({ registry, repository, name } = parseImage(
				$JobImageDetails.data.team.environment.workload.image.name
			));
		}
	});
</script>

<GraphErrors errors={$JobImageDetails.errors} />

{#if $JobImageDetails.data}
	{@const image = $JobImageDetails.data.team.environment.workload.image}
	<div class="wrapper">
		<div>
			<p>
				This page provides a list of vulnerabilities in <strong
					>{$JobImageDetails.data.team.environment.workload.name}</strong
				>
				in <Tag variant={envTagVariant($JobImageDetails.data.team.environment.environment.name)}
					>{$JobImageDetails.data.team.environment.environment.name}</Tag
				>. It includes a summary of the security status and a complete list of identified
				vulnerabilities.
			</p>

			<p>
				Review detailed information on each vulnerability and update affected dependencies to the
				latest patched version. If no upgrade path is available, vulnerabilities can be reviewed and
				suppressed by the team responsible for the workload.
			</p>

			<div>
				<ImageVulnerabilities
					team={$JobImageDetails.data?.team.slug}
					environment={$JobImageDetails.data?.team.environment.environment.name}
					workload={$JobImageDetails.data?.team.environment.workload.name}
					authorized={viewerIsMember}
				/>
			</div>
		</div>
		<div class="right">
			<div class="card">
				<Heading level="2" size="small" spacing
					><!-- TODO: This card should be called SBOM when we have more info from v13z-->Image</Heading
				>
				<Detail><strong>Registry:</strong> {registry}</Detail>
				<Detail><strong>Repository:</strong> {repository}</Detail>
				<Detail><strong>Name:</strong> {name}</Detail>
				<Detail><strong>Tag:</strong> {image.tag}</Detail>

				<!-- TODO: When we have project id from dependency track <a
					href="https://dependencytrack.nais.io/#/vulnerability-management/scan-results/scan-results?scanId=1"
					target="_blank"
					rel="noopener noreferrer"
					>Dependency Track
				</a><ExternalLinkIcon /> -->
			</div>
			<div class="card">
				<Heading level="2" size="small" spacing>Summary</Heading>
				<!-- {#if !image.hasSBOM && image.vulnerabilitySummary !== null}
					<BodyShort>
						<WarningIcon class="text-aligned-icon" /> Data was discovered, but the SBOM was not rendered.
						Refer to the <a href={docURL('/services/vulnerabilities/')}>Nais documentation</a>
						for further assistance.
					</BodyShort>
				{:else if image.vulnerabilitySummary === null}
					<BodyShort>
						<WarningIcon class="text-aligned-icon" /> No data found.
						<a href={docURL('/services/vulnerabilities/how-to/sbom/')} target="_blank">How to fix</a
						>
					</BodyShort>
				{:else if image.hasSBOM && image.vulnerabilitySummary && hasFindings}
					<VulnerabilityBadges summary={image.vulnerabilitySummary} />
				{:else if image.hasSBOM}
					<BodyShort>
						<SuccessIcon class="text-aligned-icon" /> No vulnerabilities found. Good work!
					</BodyShort>
				{/if} -->

				{#if image.vulnerabilitySummary}
					<VulnerabilityBadges summary={image.vulnerabilitySummary} />
				{:else if !image.hasSBOM && image.vulnerabilitySummary !== null}
					<WarningIcon class="text-aligned-icon" />
					Data was discovered, but the SBOM was not rendered. Refer to the
					<a href={docURL('/services/vulnerabilities/')}>Nais documentation</a>
					for further assistance.
				{:else}
					<WarningIcon class="text-aligned-icon" />
					No data found.
					<a href={docURL('/services/vulnerabilities/how-to/sbom/')}> How to fix</a>
				{/if}
			</div>
		</div>
	</div>
{/if}

<style>
	.wrapper {
		display: grid;
		grid-template-columns: 1fr 300px;
		gap: 1rem;
	}
	.right {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}
	.card {
		background-color: var(--a-surface-subtle);
		padding: var(--a-spacing-5);
		border-radius: 12px;
	}
</style>
