<script lang="ts">
	import ImageVulnerabilities from '$lib/components/image/ImageVulnerabilities.svelte';
	import VulnerabilityBadges from '$lib/components/VulnerabilityBadges.svelte';
	import { docURL } from '$lib/doc';
	import GraphErrors from '$lib/GraphErrors.svelte';
	import WarningIcon from '$lib/icons/WarningIcon.svelte';
	import { Heading } from '@nais/ds-svelte-community';
	import type { PageProps } from './$houdini';

	let { data }: PageProps = $props();

	let { JobImageDetails, viewerIsMember } = $derived(data);

	// const error = $derived(
	// 	$JobImageDetails.data?.team.environment.workload.status.errors.find(
	// 		(e) => e.__typename === 'WorkloadStatusVulnerable'
	// 	)
	// );
</script>

<GraphErrors errors={$JobImageDetails.errors} />

{#if $JobImageDetails.data}
	{@const image = $JobImageDetails.data.team.environment.workload.image}
	<div class="wrapper">
		<div class="grid">
			<div>
				<!-- {#if error}
					<ErrorMessage
						collapsible={false}
						{error}
						{docURL}
						workloadType="Job"
						teamSlug={$JobImageDetails.data.team.slug}
						workloadName={$JobImageDetails.data.team.environment.workload.name}
						environment={$JobImageDetails.data.team.environment.environment.name}
					/>
				{/if} -->
				Risk score of 154 i too high. 1 critical is too high. Update affected dependencies to their latest
				patched versions. Application is not on Nais. plz lower <br />

				Hvis ingen SBOM, stooor feilmelding!
				<img src="/SBOM.png" alt="SBOoooOooM" />
			</div>
			<div class="card">
				<Heading level="2" size="small" spacing>Summary</Heading>
				{#if image.vulnerabilitySummary}
					<VulnerabilityBadges summary={image.vulnerabilitySummary} />
				{:else if !image.hasSBOM && image.vulnerabilitySummary !== null}
					<WarningIcon class="text-aligned-icon" />
					Data was discovered, but the SBOM was not rendered. Refer to the
					<a href={docURL('/services/vulnerabilities/')}>Nais documentation</a>
					for further assistance.
				{:else}
					<WarningIcon class="text-aligned-icon" />
					No data found.
					<a href={docURL('/services/vulnerabilities/how-to/sbom/')}> How to fix</a>
				{/if}
			</div>
		</div>
		<ImageVulnerabilities
			team={$JobImageDetails.data?.team.slug}
			environment={$JobImageDetails.data?.team.environment.name}
			workload={$JobImageDetails.data?.team.environment.workload.name}
			authorized={viewerIsMember}
		/>
	</div>
{/if}

<style>
	.wrapper {
		display: grid;
		gap: 1rem;
	}
	.grid {
		display: grid;
		grid-template-columns: 1fr 300px;
		gap: 1rem;
	}
	.card {
		background-color: var(--a-surface-subtle);
		padding: var(--a-spacing-5);
		border-radius: 12px;
	}
</style>
