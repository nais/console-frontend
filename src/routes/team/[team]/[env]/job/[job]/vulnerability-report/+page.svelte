<script lang="ts">
	import ExternalLink from '$lib/components/ExternalLink.svelte';
	import ImageVulnerabilities from '$lib/components/image/ImageVulnerabilities.svelte';
	import WorkloadVulnerabilityHistoryGraph from '$lib/components/WorkloadVulnerabilityHistoryGraph.svelte';
	import WorkloadVulnerabilitySummary from '$lib/components/WorkloadVulnerabilitySummary.svelte';
	import { docURL } from '$lib/doc';
	import { envTagVariant } from '$lib/envTagVariant';
	import GraphErrors from '$lib/GraphErrors.svelte';
	import WarningIcon from '$lib/icons/WarningIcon.svelte';
	import { parseImage } from '$lib/utils/image';
	import { BodyShort, Detail, Heading, Tag } from '@nais/ds-svelte-community';
	import type { PageProps } from './$houdini';

	let { data }: PageProps = $props();

	let { JobImageDetails, viewerIsMember } = $derived(data);

	const { registry, repository, name } = $derived(
		parseImage($JobImageDetails.data?.team.environment.workload.image.name)
	);
</script>

<GraphErrors errors={$JobImageDetails.errors} />

{#if $JobImageDetails.data}
	{@const workload = $JobImageDetails.data.team.environment.workload}
	<div class="wrapper">
		<div>
			{#if workload.image.hasSBOM}
				<p>
					This page provides a list of vulnerabilities in <strong>{workload.name}</strong>
					in <Tag variant={envTagVariant(workload.teamEnvironment.environment.name)}
						>{workload.teamEnvironment.environment.name}</Tag
					>. It includes a summary of the security status and a complete list of identified
					vulnerabilities.
				</p>

				<p>
					Review detailed information on each vulnerability and update affected dependencies to the
					latest patched version. If no upgrade path is available, vulnerabilities can be reviewed
					and suppressed by the team responsible for the workload.
				</p>

				<div>
					<ImageVulnerabilities
						team={$JobImageDetails.data?.team.slug}
						environment={$JobImageDetails.data?.team.environment.environment.name}
						workload={$JobImageDetails.data?.team.environment.workload.name}
						authorized={viewerIsMember}
					/>
				</div>
			{:else}
				<BodyShort>
					<WarningIcon class="text-aligned-icon" /> No vulnerability data available. Learn how to generate
					SBOMs and attestations for your workloads in the
					<ExternalLink href={docURL('/services/vulnerabilities/how-to/sbom/')}
						>Nais documentation
					</ExternalLink>.
				</BodyShort>
			{/if}
		</div>
		<div class="right">
			<div class="card">
				<Heading level="2" size="small" spacing
					><!-- TODO: This card should be called SBOM when we have more info from v13z-->Image</Heading
				>
				{#if registry === '' || repository === '' || name === ''}
					<Detail><strong>Name:</strong> {workload.image.name}</Detail>
				{:else}
					<Detail><strong>Registry:</strong> {registry}</Detail>
					<Detail><strong>Repository:</strong> {repository}</Detail>
					<Detail><strong>Name:</strong> {name}</Detail>
				{/if}
				<Detail><strong>Tag:</strong> {workload.image.tag}</Detail>

				<!-- TODO: When we have project id from dependency track <a
				href="https://dependencytrack.nais.io/#/vulnerability-management/scan-results/scan-results?scanId=1"
				target="_blank"
				rel="noopener noreferrer"
				>Dependency Track
			</a><ExternalLinkIcon /> -->
			</div>
			{#if workload.image.hasSBOM}
				<div class="card">
					<Heading level="2" size="small" spacing>Summary</Heading>

					<WorkloadVulnerabilitySummary {workload} />
				</div>
			{/if}
		</div>
		<WorkloadVulnerabilityHistoryGraph
			team={$JobImageDetails.data?.team.slug}
			environment={$JobImageDetails.data?.team.environment.environment.name}
			workload={$JobImageDetails.data?.team.environment.workload.name}
		/>
	</div>
{/if}

<style>
	.wrapper {
		display: grid;
		grid-template-columns: 1fr 300px;
		gap: 1rem;
	}
	.right {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}
	.card {
		background-color: var(--ax-bg-sunken);
		padding: var(--ax-space-20);
		border-radius: 12px;
	}
</style>
