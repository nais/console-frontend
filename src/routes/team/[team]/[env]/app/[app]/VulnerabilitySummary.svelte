<script lang="ts">
	import type { VulnerabilitySummary } from '$houdini';
	import {PendingValue, fragment, graphql} from '$houdini';
	import Loading from '$lib/Loading.svelte';
	import {Tooltip} from '@nais/ds-svelte-community';
	import WarningIcon from "$lib/icons/WarningIcon.svelte";

	export let app: VulnerabilitySummary;
	$: data = fragment(
		app,
		graphql(`
			fragment VulnerabilitySummary on App {
				dependencyTrack @loading {
					projectName
					findingsLink
					summary {
						total
						critical
						high
						medium
						low
					}
				}
			}
		`)
	);

</script>

<div>
	{#if $data?.dependencyTrack === PendingValue}
		<Loading/>
	{:else if $data?.dependencyTrack === null}
		<WarningIcon size="1rem" style="color: var(--a-icon-warning); margin-right: 1.0rem" /><code>No data found in dependencytrack.</code>
	{:else}
		{#if $data.dependencyTrack.summary.critical > 0 }
			<Tooltip placement="right" content="severity: CRITICAL">
				<span class="circle red"> {$data.dependencyTrack.summary.critical} </span>
			</Tooltip>
		{/if}
		{#if $data.dependencyTrack.summary.high > 0 }
			<Tooltip placement="right" content="severity: HIGH">
				<span class="circle orange"> {$data.dependencyTrack.summary.high} </span>
			</Tooltip>
		{/if}
		{#if $data.dependencyTrack.summary.medium > 0 }
			<Tooltip placement="right" content="severity: MEDIUM">
				<span class="circle yellow"> {$data.dependencyTrack.summary.medium} </span>
			</Tooltip>
		{/if}
		{#if $data.dependencyTrack.summary.low > 0 }
			<Tooltip placement="right" content="severity: LOW">
				<span class="circle"> {$data.dependencyTrack.summary.low} </span>
			</Tooltip>
		{/if}
		{#if $data.dependencyTrack.summary.total === 0 }
			<Tooltip placement="right" content="No vulnerabilities found, keep up the good work!">
				<span class="circle green">0</span>
			</Tooltip>
		{:else}
			<p><a href="{$data.dependencyTrack.findingsLink}">View findings in DependencyTrack</a></p>
		{/if}
	{/if}
</div>

<style>
	div {
		display: flex;
		align-items: center;
		flex-direction: row;
		gap: 0.5rem;
	}

	.circle {
		border-radius: 50%;
		-moz-border-radius: 50%;
		-webkit-border-radius: 50%;
		border: 4px solid #6e6e6e;
		color: #6e6e6e;
		display: inline-block;
		font-weight: bold;
		margin-right: 5px;
		text-align: center;
		width: 40px;
		height: 40px;
		padding: 4px;
	}

	.red {
		border-color: #f86c6b;
	}

	.orange {
		border-color: orange;
	}

	.yellow {
		border-color: #ffc107;
	}

	.green {
		border-color: #4dbd74;
	}

	code {
		font-size: 1rem;
	}
</style>
