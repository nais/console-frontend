<script lang="ts">
	import EChart from '$lib/chart/EChart.svelte';
	import { transformVulnerabilities } from '$lib/chart/transformVulnerabilities';
	import ExternalLink from '$lib/components/ExternalLink.svelte';
	import ImageVulnerabilities from '$lib/components/image/ImageVulnerabilities.svelte';
	import WorkloadVulnerabilitySummary from '$lib/components/WorkloadVulnerabilitySummary.svelte';
	import { docURL } from '$lib/doc';
	import { envTagVariant } from '$lib/envTagVariant';
	import GraphErrors from '$lib/GraphErrors.svelte';
	import WarningIcon from '$lib/icons/WarningIcon.svelte';
	import { parseImage } from '$lib/utils/image';
	import { changeParams } from '$lib/utils/searchparams';
	import {
		BodyLong,
		BodyShort,
		CopyButton,
		Detail,
		Heading,
		Loader,
		Tag,
		ToggleGroup,
		ToggleGroupItem
	} from '@nais/ds-svelte-community';
	import type { PageProps } from './$houdini';

	let { data }: PageProps = $props();

	let { ApplicationImageDetails, viewerIsMember, interval } = $derived(data);

	const { registry, repository, name } = $derived(
		parseImage($ApplicationImageDetails.data?.team.environment.workload.image.name)
	);

	let riskScoreToggle = $state('off');

	let options = $derived(
		transformVulnerabilities(
			$ApplicationImageDetails.data?.team.environment.workload.imageVulnerabilityHistory,
			riskScoreToggle === 'on'
		)
	);
</script>

<GraphErrors errors={$ApplicationImageDetails.errors} />

{#if $ApplicationImageDetails.data}
	{@const workload = $ApplicationImageDetails.data.team.environment.workload}
	<div class="wrapper">
		<div>
			{#if workload.image.hasSBOM}
				<p>
					This page provides a list of vulnerabilities in <strong>{workload.name}</strong>
					in <Tag variant={envTagVariant(workload.teamEnvironment.environment.name)}
						>{workload.teamEnvironment.environment.name}</Tag
					>. It includes a summary of the security status and a complete list of identified
					vulnerabilities.
				</p>

				<p>
					Review detailed information on each vulnerability and update affected dependencies to the
					latest patched version. If no upgrade path is available, vulnerabilities can be reviewed
					and suppressed by the team responsible for the workload.
				</p>

				<div>
					<ImageVulnerabilities
						team={$ApplicationImageDetails.data?.team.slug}
						environment={$ApplicationImageDetails.data?.team.environment.environment.name}
						workload={$ApplicationImageDetails.data?.team.environment.workload.name}
						authorized={viewerIsMember}
					/>
				</div>
			{:else}
				<BodyShort>
					<WarningIcon class="text-aligned-icon" /> No vulnerability data available. Learn how to generate
					SBOMs and attestations for your workloads in the
					<ExternalLink href={docURL('/services/vulnerabilities/how-to/sbom/')}
						>Nais documentation
					</ExternalLink>.
				</BodyShort>
			{/if}
		</div>
		<div class="right">
			<div class="card">
				<div class="image_heading">
					<Heading level="2" size="small" spacing
						><!-- TODO: This card should be called SBOM when we have more info from v13z-->Image
					</Heading>
					<div style="margin-bottom: var(--ax-space-12);">
						<CopyButton
							copyText={$ApplicationImageDetails.data?.team.environment.workload.image.name}
							size="small"
							variant="action"
						/>
					</div>
				</div>
				{#if registry === '' || repository === '' || name === ''}
					<Detail><strong>Name:</strong> {workload.image.name}</Detail>
				{:else}
					<Detail><strong>Registry:</strong> {registry}</Detail>
					<Detail><strong>Repository:</strong> {repository}</Detail>
					<Detail><strong>Name:</strong> {name}</Detail>
				{/if}
				<Detail><strong>Tag:</strong> {workload.image.tag}</Detail>

				<!-- TODO: When we have project id from dependency track <a
					href="https://dependencytrack.nais.io/#/vulnerability-management/scan-results/scan-results?scanId=1"
					target="_blank"
					rel="noopener noreferrer"
					>Dependency Track
				</a><ExternalLinkIcon /> -->
			</div>
			{#if workload.image.hasSBOM}
				<div class="card">
					<Heading level="2" size="small" spacing>Summary</Heading>

					<WorkloadVulnerabilitySummary {workload} />
				</div>
			{/if}
		</div>
		<div class="graph">
			<div class="heading">
				<div class="content">
					<Heading level="2" spacing
						>Vulnerability History for <strong
							>{$ApplicationImageDetails.data?.team.environment.workload.name}</strong
						></Heading
					>
					<BodyLong>
						This stacked line chart displays the accumulation of image vulnerabilities over time,
						categorized by severity level. Use the interval selector to adjust the time range.
						Enable the Risk Score toggle to weight each severity by its impact.
					</BodyLong>
				</div>
			</div>
			{#if !$ApplicationImageDetails.fetching}
				<div class="toggles">
					<ToggleGroup
						label="Interval"
						value={interval}
						onchange={(interval) => changeParams({ interval }, { noScroll: true })}
					>
						{#each ['6m', '30d', '7d'] as interval (interval)}
							<ToggleGroupItem value={interval}>{interval}</ToggleGroupItem>
						{/each}
					</ToggleGroup>
					<ToggleGroup
						label="Risk score"
						value={riskScoreToggle}
						onchange={(val) => (riskScoreToggle = val)}
					>
						<ToggleGroupItem value="off">Off</ToggleGroupItem>
						<ToggleGroupItem value="on">On</ToggleGroupItem>
					</ToggleGroup>
				</div>
				{#key options}
					<EChart {options} style="height: 500px" />
				{/key}
			{:else}
				<div style="display: flex; justify-content: center; align-items: center; height: 500px;">
					<Loader size="3xlarge" />
				</div>
			{/if}
		</div>
	</div>
{/if}

<style>
	.wrapper {
		display: grid;
		grid-template-columns: 1fr 300px;
		gap: 1rem;
	}
	.right {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}
	.card {
		background-color: var(--ax-bg-sunken);
		padding: var(--ax-space-20);
		border-radius: 12px;
	}

	.graph {
		grid-column: 1 / -1;
		display: flex;
		flex-direction: column;
	}

	.heading {
		display: flex;
		justify-content: space-between;
		align-items: flex-end;
		gap: var(--spacing-layout);
		padding-bottom: var(--spacing-layout);
	}

	.image_heading {
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: var(--spacing-layout);
	}
	.content {
		max-width: 80ch;
	}
	.toggles {
		display: flex;
		gap: var(--spacing-layout);
		flex-direction: row;
		justify-content: flex-end;
	}
</style>
