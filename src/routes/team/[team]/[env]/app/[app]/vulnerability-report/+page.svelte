<script lang="ts">
	import EChart from '$lib/chart/EChart.svelte';
	import ExternalLink from '$lib/components/ExternalLink.svelte';
	import ImageVulnerabilities from '$lib/components/image/ImageVulnerabilities.svelte';
	import WorkloadVulnerabilitySummary from '$lib/components/WorkloadVulnerabilitySummary.svelte';
	import { docURL } from '$lib/doc';
	import { envTagVariant } from '$lib/envTagVariant';
	import GraphErrors from '$lib/GraphErrors.svelte';
	import WarningIcon from '$lib/icons/WarningIcon.svelte';
	import { parseImage } from '$lib/utils/image';
	import { severityToColor } from '$lib/utils/vulnerabilities';
	import { BodyShort, Detail, Heading, Tag } from '@nais/ds-svelte-community';
	import { type EChartsOption } from 'echarts';
	import type { OptionDataValue } from 'echarts/types/src/util/types.js';
	import type { PageProps } from './$houdini';

	let { data }: PageProps = $props();

	let { ApplicationImageDetails, viewerIsMember } = $derived(data);

	const { registry, repository, name } = $derived(
		parseImage($ApplicationImageDetails.data?.team.environment.workload.image.name)
	);

	export function options(
		data: {
			date: Date;
			summary: {
				critical: number;
				high: number;
				medium: number;
				low: number;
				unassigned: number;
				riskScore: number;
			};
		}[]
	): EChartsOption {
		const seriesData: { [service: string]: [number, number][] } = {};
		const allLevels = new Set<string>();

		// Iterate through the data to collect all services and their respective severity levels
		data.forEach((entry) => {
			// Collect all services
			Object.keys(entry.summary).forEach((severity) => {
				allLevels.add(severity);
			});
		});

		data.forEach((entry) => {
			// Initialize series data for each severity level
			seriesData['critical'] = seriesData['critical'] || [];
			seriesData['high'] = seriesData['high'] || [];
			seriesData['medium'] = seriesData['medium'] || [];
			seriesData['low'] = seriesData['low'] || [];
			seriesData['unassigned'] = seriesData['unassigned'] || [];
			seriesData['riskScore'] = seriesData['riskScore'] || [];

			// Push the data for each severity level
			seriesData['critical'].push([entry.date.getTime(), entry.summary.critical * 10]);
			seriesData['high'].push([entry.date.getTime(), entry.summary.high * 5]);
			seriesData['medium'].push([entry.date.getTime(), entry.summary.medium * 3]);
			seriesData['low'].push([entry.date.getTime(), entry.summary.low * 1]);
			seriesData['unassigned'].push([entry.date.getTime(), entry.summary.unassigned * 5]);
			seriesData['riskScore'].push([entry.date.getTime(), entry.summary.riskScore]);
		});

		// Prepare the series for ECharts
		const series = Array.from(allLevels).map((level) => {
			if (level === 'riskScore') {
				return {
					name: level,
					type: 'line',
					color: '#000000',
					showSymbol: false,
					data: seriesData[level]
				};
			}
			return {
				name: level,
				type: 'line',
				stack: 'Vulnz',
				areaStyle: {
					opacity: 1
				},
				color: severityToColor({ severity: level, isGraph: true }),
				showSymbol: false,
				data: seriesData[level]
			};
		});

		console.log('series', series);

		// Return the ECharts option object
		return {
			animation: false,
			title:
				series.length === 0
					? {
							text: 'No data',
							left: 'center',
							top: 'center',
							textStyle: {
								color: '#aaa'
							}
						}
					: {},
			tooltip: {
				trigger: series.length > 10 ? 'item' : 'axis',
				axisPointer: {
					type: 'shadow'
				},
				valueFormatter(value: OptionDataValue[]) {
					return value[1];
				}
			},
			legend: {
				selector: [{ title: 'Inverse selection', type: 'inverse' }],
				data: Array.from(allLevels)
			},
			// grid: {
			// 	left: '3%',
			// 	right: '4%',
			// 	bottom: '3%',
			// 	containLabel: true
			// },
			xAxis: [
				{
					type: 'time',
					boundaryGap: false
				}
			],
			yAxis: [
				{
					type: 'value',
					axisLabel: {
						formatter: (value: number) => value
					},
					name: 'Risk score'
				}
			],
			series
		} as EChartsOption;
	}
</script>

<GraphErrors errors={$ApplicationImageDetails.errors} />

{#if $ApplicationImageDetails.data}
	{@const workload = $ApplicationImageDetails.data.team.environment.workload}
	<div class="wrapper">
		<div>
			{#if workload.image.hasSBOM}
				<p>
					This page provides a list of vulnerabilities in <strong>{workload.name}</strong>
					in <Tag variant={envTagVariant(workload.teamEnvironment.environment.name)}
						>{workload.teamEnvironment.environment.name}</Tag
					>. It includes a summary of the security status and a complete list of identified
					vulnerabilities.
				</p>

				<p>
					Review detailed information on each vulnerability and update affected dependencies to the
					latest patched version. If no upgrade path is available, vulnerabilities can be reviewed
					and suppressed by the team responsible for the workload.
				</p>

				<div>
					<EChart options={options(workload.vulnerabilityHistory)} />
				</div>

				<div>
					<ImageVulnerabilities
						team={$ApplicationImageDetails.data?.team.slug}
						environment={$ApplicationImageDetails.data?.team.environment.environment.name}
						workload={$ApplicationImageDetails.data?.team.environment.workload.name}
						authorized={viewerIsMember}
					/>
				</div>
			{:else}
				<BodyShort>
					<WarningIcon class="text-aligned-icon" /> No vulnerability data available. Learn how to generate
					SBOMs and attestations for your workloads in the
					<ExternalLink href={docURL('/services/vulnerabilities/how-to/sbom/')}
						>Nais documentation
					</ExternalLink>.
				</BodyShort>
			{/if}
		</div>
		<div class="right">
			<div class="card">
				<Heading level="2" size="small" spacing
					><!-- TODO: This card should be called SBOM when we have more info from v13z-->Image</Heading
				>
				{#if registry === '' || repository === '' || name === ''}
					<Detail><strong>Name:</strong> {workload.image.name}</Detail>
				{:else}
					<Detail><strong>Registry:</strong> {registry}</Detail>
					<Detail><strong>Repository:</strong> {repository}</Detail>
					<Detail><strong>Name:</strong> {name}</Detail>
				{/if}
				<Detail><strong>Tag:</strong> {workload.image.tag}</Detail>

				<!-- TODO: When we have project id from dependency track <a
					href="https://dependencytrack.nais.io/#/vulnerability-management/scan-results/scan-results?scanId=1"
					target="_blank"
					rel="noopener noreferrer"
					>Dependency Track
				</a><ExternalLinkIcon /> -->
			</div>
			{#if workload.image.hasSBOM}
				<div class="card">
					<Heading level="2" size="small" spacing>Summary</Heading>

					<WorkloadVulnerabilitySummary {workload} />
				</div>
			{/if}
		</div>

		<!--Table>
			<Thead>
				<Tr>
					<Td>date</Td>
					<Td>critical</Td>
					<Td>high</Td>
					<Td>medium</Td>
					<Td>low</Td>
					<Td>unassigned</Td>
				</Tr>
			</Thead>
			<Tbody>
				{#each workload.vulnerabilityHistory as summary (summary.date)}
					<Tr>
						<Td>{summary.date}</Td>
						<Td>{summary.summary.critical}</Td>
						<Td>{summary.summary.high}</Td>
						<Td>{summary.summary.medium}</Td>
						<Td>{summary.summary.low}</Td>
						<Td>{summary.summary.unassigned}</Td>
					</Tr>
				{/each}
			</Tbody>
		</Table-->
	</div>
{/if}

<style>
	.wrapper {
		display: grid;
		grid-template-columns: 1fr 300px;
		gap: 1rem;
	}
	.right {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}
	.card {
		background-color: var(--ax-bg-sunken, --a-surface-subtle);
		padding: var(--ax-space-20, --a-spacing-5);
		border-radius: 12px;
	}
</style>
