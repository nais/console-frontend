<script lang="ts" module>
	type ImageVulnerabilityHistory =
		| {
				samples: {
					date: Date;
					summary: {
						critical: number;
						high: number;
						low: number;
						medium: number;
						unassigned: number;
					};
				}[];
		  }
		| undefined
		| null;
</script>

<script lang="ts" generics="T extends ImageVulnerabilityHistory">
	import type { intervalOptionsVulnerabilityHistory } from '$lib/components/vulnerability/dateUtils';
	import { isReducedMotion } from '$lib/reducedMotion';
	import {
		allSeverities,
		severityToColor,
		severityToRiskScore,
		type Severity
	} from '$lib/utils/vulnerabilities';
	import { format as layerchartFormat } from '@layerstack/utils';
	import { format } from 'date-fns';
	import { accessor, AreaChart, Tooltip, type SeriesData } from 'layerchart';
	import type { VulnerabilitiesChartData } from './transformVulnerabilities';

	const {
		isRiskScore = false,
		data,
		interval = '7d'
	}: {
		isRiskScore?: boolean;
		data: T;
		interval?: (typeof intervalOptionsVulnerabilityHistory)[number];
	} = $props();

	function transformLayerchartVulnerabilities(
		data: ImageVulnerabilityHistory,
		riskScoreToggle: boolean
	): { data: VulnerabilitiesChartData[]; series: object[] } {
		if (!data || !data?.samples.length) {
			return { data: [], series: [] };
		}

		const seriesData: VulnerabilitiesChartData[] = [];
		for (const entry of data.samples) {
			// eslint-disable-next-line svelte/prefer-svelte-reactivity
			const theDate = new Date(entry.date);
			theDate.setHours(0, 0, 0, 0);

			const entryData: VulnerabilitiesChartData = { date: theDate };

			for (const severity of allSeverities) {
				const rawCount = entry.summary[severity.toLowerCase() as keyof typeof entry.summary] ?? 0;
				const value = riskScoreToggle ? rawCount * severityToRiskScore[severity] : rawCount;
				entryData[severity] = value;
			}

			seriesData.push(entryData);
		}

		return {
			data: seriesData,
			series: []
		};
	}

	function calculateTooltipRiskScore(
		data: VulnerabilitiesChartData,
		series: SeriesData<VulnerabilitiesChartData, never>[]
	) {
		return series.reduce((acc, curr) => {
			const val = accessor(curr.value ?? curr.key)(data);
			if (isRiskScore) {
				return acc + val;
			}
			return acc + val * severityToRiskScore[curr.key as Severity];
		}, 0);
	}
</script>

<AreaChart
	yNice
	padding={{ top: 24, bottom: 24, left: 40, right: 40 }}
	data={transformLayerchartVulnerabilities(data, isRiskScore).data}
	series={allSeverities.reverse().map((severity) => ({
		key: severity,
		color: severityToColor({ severity: severity.toLowerCase() })
	}))}
	seriesLayout="stack"
	x="date"
	legend={{
		placement: 'top',
		classes: {
			root: 'mb-2'
		}
	}}
	props={{
		area: {
			fillOpacity: 0.8,
			class: 'pl-4',
			motion: isReducedMotion ? 'none' : 'tween'
		},
		yAxis: {
			label: '# of vulnerabilities',
			labelPlacement: 'start'
		},
		xAxis: {
			motion: isReducedMotion ? 'none' : 'tween',
			format:
				interval === '6m'
					? 'month'
					: (value: Date) => {
							if (!value) return '';
							return format(value, 'dd/MM');
						},
			tickSpacing: 150
		}
	}}
>
	{#snippet tooltip({ series, context })}
		<Tooltip.Root>
			{#snippet children({ data })}
				<Tooltip.Header>{format(context.x(data), 'dd/MM/yyyy')}</Tooltip.Header>
				<Tooltip.List>
					<Tooltip.Item label="Risk score">
						{calculateTooltipRiskScore(data, series)}
					</Tooltip.Item>
					<Tooltip.Separator />
					{#each series as s (s.key)}
						{@const valueAccessor = accessor(s.value ?? s.key)}
						<Tooltip.Item label={s.key} color={s.color}>
							{layerchartFormat(valueAccessor(data))}
						</Tooltip.Item>
					{/each}
				</Tooltip.List>
			{/snippet}
		</Tooltip.Root>
	{/snippet}
</AreaChart>
