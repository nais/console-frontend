<script lang="ts" module>
	type ImageVulnerabilityHistory =
		| {
				samples: {
					date: Date;
					summary: {
						critical: number;
						high: number;
						low: number;
						medium: number;
						unassigned: number;
					};
				}[];
		  }
		| undefined
		| null;
</script>

<script lang="ts" generics="T extends ImageVulnerabilityHistory">
	import type { intervalOptionsVulnerabilityHistory } from '$lib/domain/vulnerability/dateUtils';
	import { isReducedMotion } from '$lib/reducedMotion';
	import {
		allSeverities,
		severityToColor,
		severityToRiskScore,
		type Severity
	} from '$lib/utils/vulnerabilities';
	import { format as layerchartFormat } from '@layerstack/utils';
	import { format } from 'date-fns';
	import { accessor, AreaChart, Tooltip, type SeriesData } from 'layerchart';
	import { SvelteDate } from 'svelte/reactivity';
	import LegendWrapper, { legendSnippet } from './LegendWrapper.svelte';

	const {
		data,
		interval = '7d',
		height = '300px'
	}: {
		data: T;
		interval?: (typeof intervalOptionsVulnerabilityHistory)[number];
		height?: `${number}px`;
	} = $props();

	type VulnerabilitiesChartData = {
		date: Date;
		[key: string]: number | Date;
	};

	function transformLayerchartVulnerabilities(data: ImageVulnerabilityHistory): {
		data: VulnerabilitiesChartData[];
		series: { key: string; color: string }[];
	} {
		if (!data || !data?.samples.length) {
			return { data: [], series: [] };
		}

		const seriesData: VulnerabilitiesChartData[] = [];
		for (const entry of data.samples) {
			const theDate = new SvelteDate(entry.date);
			theDate.setHours(0, 0, 0, 0);

			const entryData: VulnerabilitiesChartData = { date: theDate };

			for (const severity of allSeverities) {
				const summaryKey = severity.toLowerCase() as keyof typeof entry.summary;
				const value = entry.summary[summaryKey] ?? 0;
				entryData[severity] = value;
			}

			seriesData.push(entryData);
		}

		const series = [...allSeverities].reverse().map((severity) => {
			const color = severityToColor({ severity: severity.toLowerCase() });
			return {
				key: severity,
				color: color
			};
		});

		return {
			data: seriesData,
			series: series
		};
	}

	function calculateTooltipRiskScore(
		data: VulnerabilitiesChartData,
		series: SeriesData<VulnerabilitiesChartData, never>[]
	) {
		return series.reduce((acc, curr) => {
			const val = accessor(curr.value ?? curr.key)(data);
			return acc + val * severityToRiskScore[curr.key as Severity];
		}, 0);
	}

	const chartData = $derived.by(() => {
		const result = transformLayerchartVulnerabilities(data);
		return result;
	});
</script>

<LegendWrapper {height}>
	<AreaChart
		yNice
		padding={{ top: 24, bottom: 24, left: 40, right: 40 }}
		data={chartData.data}
		series={chartData.series}
		seriesLayout="stack"
		x="date"
		legend={legendSnippet}
		props={{
			area: {
				fillOpacity: 0.8,
				class: 'pl-4',
				motion: isReducedMotion ? 'none' : 'tween'
			},
			yAxis: {
				label: '# of vulnerabilities',
				labelPlacement: 'start'
			},
			xAxis: {
				motion: isReducedMotion ? 'none' : 'tween',
				format:
					interval === '6m'
						? 'month'
						: (value: Date) => {
								if (!value) return '';
								return format(value, 'dd/MM');
							},
				tickSpacing: 150
			}
		}}
	>
		{#snippet tooltip({ series, context })}
			<Tooltip.Root>
				{#snippet children({ data })}
					<Tooltip.Header>{format(context.x(data), 'dd/MM/yyyy')}</Tooltip.Header>
					<Tooltip.List>
						<Tooltip.Item label="Risk score">
							{calculateTooltipRiskScore(data, series)}
						</Tooltip.Item>
						<Tooltip.Separator />
						{#each allSeverities as severityKey (severityKey)}
							{@const seriesItem = series.find((s) => s.key === severityKey)}
							{@const valueAccessor = accessor(severityKey)}
							<Tooltip.Item label={severityKey} color={seriesItem?.color}>
								{layerchartFormat(valueAccessor(data))}
							</Tooltip.Item>
						{/each}
					</Tooltip.List>
				{/snippet}
			</Tooltip.Root>
		{/snippet}
	</AreaChart>
</LegendWrapper>
