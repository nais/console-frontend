<script lang="ts" module>
	export type FindingType = {
		id: string;
		description: string;
		identifier: string;
		package: string;
		severity: ValueOf<typeof ImageVulnerabilitySeverity>;
		suppression: {
			reason: string;
			state: ValueOf<typeof ImageVulnerabilitySuppressionState>;
		} | null;
		vulnerabilityDetailsLink: string;
	};
</script>

<script lang="ts">
	import { goto } from '$app/navigation';
	import { page } from '$app/state';
	import { graphql, ImageVulnerabilitySuppressionState, type ValueOf } from '$houdini';
	import type { ImageVulnerabilitySeverity } from '$houdini/graphql/enums';
	import WorkloadLink from '$lib/domain/workload/WorkloadLink.svelte';
	import ExternalLink from '$lib/ui/ExternalLink.svelte';
	import { suppressionStateOptions as SUPPRESS_OPTIONS } from '$lib/utils/vulnerabilities';
	import {
		Alert,
		BodyShort,
		Button,
		Heading,
		Modal,
		Select,
		Table,
		Tbody,
		Td,
		TextField,
		Th,
		Thead,
		Tr
	} from '@nais/ds-svelte-community';
	import { createEventDispatcher } from 'svelte';

	interface Props {
		open: boolean;
		finding: FindingType;
		workloads: {
			readonly id: string;
			readonly __typename: string | null;
			readonly team: {
				readonly slug: string;
			};
			readonly teamEnvironment: { readonly environment: { readonly name: string } };
			readonly name: string;
		}[];
		authorized: boolean;
	}

	let { open = $bindable(), finding, workloads, authorized }: Props = $props();

	let errormessage = $state('');

	let selectedReason: ValueOf<typeof ImageVulnerabilitySuppressionState> | '' = $state('');
	let inputText = $state('');

	let team = page.params.team;
	let env = page.params.env;
	let workload = page.params.app ?? page.params.job;

	// check if route contains app or job
	if (page.route.id && page.route.id.includes('app')) {
		workload = 'app/' + page.params.app;
	} else {
		workload = 'job/' + page.params.job;
	}

	const dispatcher = createEventDispatcher<{ close: void }>();

	const close = () => {
		open = false;
		errormessage = '';
		dispatcher('close');
	};

	const removeSuppress = async () => {
		errormessage = '';

		await suppress.mutate({
			analysisState: null,
			comment: '',
			vulnerabilityID: finding.id,
			suppress: false
		});

		if ($suppress.errors) {
			if (errormessage === '') {
				errormessage = $suppress.errors[0].message;
			}
			open = true;
			return;
		}

		errormessage = '';
		const vulnerabilityReportUrl =
			'/team/' + team + '/' + env + '/' + workload + '/vulnerabilities';
		close();
		await goto(vulnerabilityReportUrl, { replaceState: true });
	};

	const triggerSuppress = async () => {
		errormessage = '';

		if (selectedReason === '') {
			errormessage += 'Select a suppress reason from the Analysis dropdown.';
			return;
		}

		if (inputText === '') {
			errormessage += 'Provide a comment before suppressing the finding. ';
			return;
		}

		await suppress.mutate({
			analysisState: selectedReason,
			comment: inputText,
			vulnerabilityID: finding.id,
			suppress: true
		});

		if ($suppress.errors) {
			if (errormessage === '') {
				errormessage = $suppress.errors[0].message;
			}
			open = true;
			return;
		}

		errormessage = '';
		const vulnerabilityReportUrl =
			'/team/' + team + '/' + env + '/' + workload + '/vulnerabilities';
		close();
		await goto(vulnerabilityReportUrl, { replaceState: true });
	};

	// TODO: needs refresh
	const suppress = graphql(`
		mutation SuppressFinding(
			$analysisState: ImageVulnerabilitySuppressionState
			$comment: String!
			$suppress: Boolean!
			$vulnerabilityID: ID!
		) {
			updateImageVulnerability(
				input: {
					state: $analysisState
					reason: $comment
					suppress: $suppress
					vulnerabilityID: $vulnerabilityID
				}
			) {
				vulnerability {
					suppression {
						reason
						state
					}
				}
			}
		}
	`);

	const init = (finding: FindingType) => {
		inputText = finding.suppression?.reason ?? '';
		selectedReason = finding.suppression?.state ?? '';
	};

	$effect(() => {
		init(finding);
	});
</script>

<Modal bind:open width="medium" onclose={close}>
	{#snippet header()}
		<Heading level="1" size="medium">
			{authorized ? 'Suppress Finding for' : 'Finding'}
			{finding.identifier}
		</Heading>
	{/snippet}

	<div class="info">
		<dl>
			<dt>Package:</dt>
			<dd><code>{finding.package}</code></dd>
			<dt>Details:</dt>
			<dd>
				<ExternalLink href={finding.vulnerabilityDetailsLink}
					>{finding.vulnerabilityDetailsLink}</ExternalLink
				>
			</dd>
			<dt>All Affected:</dt>
			<dd>
				<a href="/vulnerabilities/{finding.identifier}">View all workloads with this vulnerability</a>
			</dd>
		</dl>
	</div>
	<div class="workload">
		<Heading level="2" size="small">Workloads Using This Image</Heading>
		<Table size="small">
			<Thead>
				<Tr>
					<Th>Team</Th>
					<Th>Workload</Th>
				</Tr>
			</Thead>
			<Tbody>
				{#each workloads as workload (workload.id)}
					<Tr>
						<Td>{workload.team.slug}</Td>
						<Td><WorkloadLink hideTeam {workload} /></Td>
					</Tr>
				{/each}
			</Tbody>
		</Table>
	</div>
	{#if authorized}
		<div class="wrapper">
			{#if errormessage !== ''}
				<Alert variant="error">
					{errormessage}
				</Alert>
			{/if}
			<BodyShort>
				Provide a reason for suppressing this finding. This will be recorded in the analysis audit
				log. Suppression will be in effect for all workloads using this image.
			</BodyShort>
			<Select size="small" label="Analysis" bind:value={selectedReason}>
				{#each SUPPRESS_OPTIONS as option (option)}
					{#if option.value === finding.suppression?.state}
						<option value={option.value}>{option.text} </option>
					{:else}
						<option value={option.value}>{option.text}</option>
					{/if}
				{/each}
			</Select>

			<TextField type="text" bind:value={inputText}>
				{#snippet label()}
					Comment
				{/snippet}
			</TextField>
			{#if finding.suppression}
				<Button style="align-self: end;" variant="danger" size="small" onclick={removeSuppress}
					>Remove Suppression</Button
				>
			{/if}
		</div>
	{/if}
	{#snippet footer()}
		{#if authorized}
			<Button variant="primary" size="small" onclick={triggerSuppress}
				>{finding.suppression ? 'Update' : 'Suppress'}</Button
			>
			<Button variant="secondary" size="small" onclick={close}>Cancel</Button>
		{/if}
	{/snippet}
</Modal>

<style>
	.wrapper {
		border: 1px solid #d6d8db;
		display: flex;
		flex-direction: column;
		padding: 1rem;
		gap: 1rem;
	}
	code {
		font-size: 0.9rem;
	}

	.workload {
		margin: 1rem 0;
	}
	.info {
		margin: 1rem 0;
	}
	dt {
		font-weight: bold;
	}
</style>
