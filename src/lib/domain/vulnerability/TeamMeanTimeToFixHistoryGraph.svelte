<script lang="ts">
	import { graphql } from '$houdini';
	import MeanTimeToFixChart from '$lib/chart/MeanTimeToFixChart.svelte';
	import {
		getFromForVulnerabilityHistory,
		intervalOptionsVulnerabilityHistory
	} from '$lib/domain/vulnerability/dateUtils';
	import {
		BodyLong,
		Heading,
		Loader,
		ToggleGroup,
		ToggleGroupItem
	} from '@nais/ds-svelte-community';

	interface Props {
		teamSlug: string;
	}

	let { teamSlug: team }: Props = $props();

	let interval: (typeof intervalOptionsVulnerabilityHistory)[number] = $state('7d');

	const query = graphql(`
		query TeamMeanTimeToFixHistory($team: Slug!, $from: Date!) {
			team(slug: $team) {
				slug
				vulnerabilityFixHistory(from: $from) {
					samples {
						severity
						date
						days
						fixedCount
						firstFixedAt
						lastFixedAt
					}
				}
			}
		}
	`);

	$effect(() => {
		query.fetch({
			variables: {
				team: team,
				from: getFromForVulnerabilityHistory(interval)
			}
		});
	});
</script>

<div class="graph">
	<div class="heading">
		<div class="content">
			<Heading level="2" spacing>
				Mean Time To Fix History for <strong>{$query.data?.team.slug}</strong>
			</Heading>
			<BodyLong>
				Track the average time to fix vulnerabilities by severity level over time. Use the interval
				selector to adjust the time range and analyze your team's remediation trends.
			</BodyLong>
		</div>
	</div>

	{#if !$query.fetching}
		<div class="toggles">
			<ToggleGroup label="Interval" bind:value={interval}>
				{#each intervalOptionsVulnerabilityHistory as intervalOption (intervalOption)}
					<ToggleGroupItem value={intervalOption}>{intervalOption}</ToggleGroupItem>
				{/each}
			</ToggleGroup>
		</div>

		{#if $query.data?.team.vulnerabilityFixHistory}
			<div class="h-[500px]">
				<MeanTimeToFixChart data={$query.data?.team.vulnerabilityFixHistory} {interval} />
			</div>
		{:else}
			<BodyLong size="large" spacing>No Mean Time To Fix data available for this team.</BodyLong>
		{/if}
	{:else}
		<div style="display: flex; justify-content: center; align-items: center; min-height: 500px;">
			<Loader size="3xlarge" />
		</div>
	{/if}
</div>

<style>
	.graph {
		display: flex;
		flex-direction: column;
	}

	.heading {
		display: flex;
		justify-content: space-between;
		align-items: flex-end;
		gap: var(--spacing-layout);
	}

	.content {
		max-width: 80ch;
	}

	.toggles {
		display: flex;
		gap: var(--spacing-layout);
		flex-direction: row;
		justify-content: flex-end;
	}
</style>
