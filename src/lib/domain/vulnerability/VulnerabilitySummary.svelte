<script lang="ts">
	import { graphql, TeamVulnerabilityRiskScoreTrend } from '$houdini';
	import Time from '$lib/ui/Time.svelte';
	import { numberFormatter, percentageFormatter } from '$lib/utils/formatters';
	import { Heading, Loader, Tooltip } from '@nais/ds-svelte-community';
	import { CaretDownFillIcon, CaretUpFillIcon } from '@nais/ds-svelte-community/icons';

	const query = graphql(`
		query VulnerabilitySummary($team: Slug!) {
			team(slug: $team) {
				vulnerabilitySummary {
					sbomCount
					coverage
					critical
					riskScore
					riskScoreTrend
					lastUpdated
				}
				workloads {
					pageInfo {
						totalCount
					}
				}
			}
		}
	`);

	$effect(() => {
		query.fetch({
			variables: {
				team: teamSlug
			}
		});
	});

	interface Props {
		teamSlug: string;
	}

	let { teamSlug }: Props = $props();
</script>

<div class="wrapper">
	<Heading size="small" as="h2"
		><a href="/team/{teamSlug}/vulnerabilities">Vulnerability Summary</a></Heading
	>
	{#if $query.errors?.length ?? 0 > 0}
		<span style="color: var(--ax-border-danger-strong)"
			>ERROR: Unable to fetch vulnerability data.</span
		>
	{:else if $query.data && $query.data.team.vulnerabilitySummary && $query.data.team.workloads}
		{#if $query.data.team.vulnerabilitySummary.lastUpdated}
			<div class="last-updated">
				Last updated <Time time={$query.data.team.vulnerabilitySummary.lastUpdated} distance />
			</div>
		{/if}

		<div class="grid">
			<span
				style={$query.data.team.vulnerabilitySummary.coverage < 90
					? 'color: var(--ax-text-danger)'
					: 'color: inherit'}
				>{percentageFormatter($query.data.team.vulnerabilitySummary.coverage, 0)}</span
			>
			<div>
				{numberFormatter($query.data.team.vulnerabilitySummary.sbomCount)} of {numberFormatter(
					$query.data.team.workloads.pageInfo.totalCount
				)}
				workloads have SBOM
			</div>

			<span class="vulnerability-count"
				>{numberFormatter($query.data.team.vulnerabilitySummary.critical)}</span
			>
			<div>Critical vulnerabilities</div>

			<div>
				{numberFormatter(
					$query.data.team.vulnerabilitySummary.riskScore
				)}{#if $query.data.team.vulnerabilitySummary.riskScoreTrend === TeamVulnerabilityRiskScoreTrend.UP}
					<Tooltip content="Risk score is trending up"
						><CaretUpFillIcon style="color: var(--ax-text-danger-decoration);" /></Tooltip
					>
				{:else if $query.data.team.vulnerabilitySummary.riskScoreTrend === TeamVulnerabilityRiskScoreTrend.DOWN}
					<Tooltip content="Risk score is trending down"
						><CaretDownFillIcon style="color: var(--ax-text-success-decoration);" /></Tooltip
					>
				{/if}
			</div>
			<div>Total risk score</div>
		</div>
	{:else}
		<div class="loading h-[250px]">
			<Loader size="3xlarge" />
		</div>
	{/if}
</div>

<style>
	.grid {
		display: grid;
		grid-template-columns: auto 1fr;
		column-gap: var(--ax-space-16);
		row-gap: var(--ax-space-16);
		align-items: center;

		> :nth-child(2n + 1) {
			font-size: 1.6rem;
			font-weight: 600;
			justify-self: center;
		}
	}

	.vulnerability-count {
		border-radius: 4px;
		padding: 4px 16px;
	}

	.wrapper {
		display: flex;
		flex-direction: column;
	}
	.last-updated {
		grid-column: span 2;
		color: var(--ax-text-info-subtle);
		font-size: 0.9rem;
	}
	.loading {
		display: flex;
		justify-content: center;
		align-items: center;
		height: 200px;
		width: 100%;
	}
</style>
