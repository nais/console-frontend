<script lang="ts">
	import { graphql } from '$houdini';
	import VulnerabilityChart from '$lib/chart/VulnerabilityChart.svelte';
	import {
		getFromForVulnerabilityHistory,
		intervalOptionsVulnerabilityHistory
	} from '$lib/domain/vulnerability/dateUtils';
	import { BodyLong, Heading, ToggleGroup, ToggleGroupItem } from '@nais/ds-svelte-community';

	interface Props {
		team: string;
		environment: string;
		workload: string;
	}

	let { team, environment, workload }: Props = $props();

	let interval: (typeof intervalOptionsVulnerabilityHistory)[number] = $state('7d');

	const query = graphql(`
		query WorkloadVulnerabilityHistory(
			$team: Slug!
			$env: String!
			$workload: String!
			$from: Date!
		) {
			team(slug: $team) {
				environment(name: $env) {
					workload(name: $workload) {
						name
						imageVulnerabilityHistory(from: $from) {
							samples {
								date
								summary {
									critical
									high
									medium
									low
									unassigned
								}
							}
						}
					}
				}
			}
		}
	`);

	$effect(() => {
		query.fetch({
			variables: {
				team: team,
				env: environment,
				workload: workload,
				from: getFromForVulnerabilityHistory(interval)
			}
		});
	});
</script>

<div class="graph">
	<div class="heading">
		<div class="content">
			<Heading as="h2" spacing
				>Vulnerability History for <strong>{$query.data?.team.environment.workload.name}</strong
				></Heading
			>
			<BodyLong>
				Track the accumulation of image vulnerabilities by severity level over time. Use the
				interval selector to adjust the time range and monitor trends.
			</BodyLong>
		</div>
	</div>
	{#if !$query.fetching}
		<div class="toggles">
			<ToggleGroup
				label="Interval"
				value={interval}
				onchange={(i) => (interval = i as typeof interval)}
			>
				{#each intervalOptionsVulnerabilityHistory as interval (interval)}
					<ToggleGroupItem value={interval}>{interval}</ToggleGroupItem>
				{/each}
			</ToggleGroup>
		</div>
		{#if $query.data?.team.environment.workload.imageVulnerabilityHistory}
			<div class="h-[500px]">
				<VulnerabilityChart
					data={$query.data?.team.environment.workload.imageVulnerabilityHistory}
					{interval}
				/>
			</div>
		{:else}
			<BodyLong size="large" spacing
				>No vulnerability history data available for this workload.</BodyLong
			>
		{/if}
	{/if}
</div>

<style>
	.graph {
		grid-column: 1 / -1;
		display: flex;
		flex-direction: column;
	}

	.heading {
		display: flex;
		justify-content: space-between;
		align-items: flex-end;
		gap: var(--spacing-layout);
		padding-bottom: var(--spacing-layout);
	}

	.content {
		max-width: 80ch;
	}
	.toggles {
		display: flex;
		gap: var(--spacing-layout);
		flex-direction: row;
		justify-content: flex-end;
	}
</style>
