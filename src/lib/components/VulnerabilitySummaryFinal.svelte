<script lang="ts">
	import { graphql, TeamVulnerabilityRiskScoreTrend } from '$houdini';
	import { severityToColor } from '$lib/utils/vulnerabilities';
	import { Heading } from '@nais/ds-svelte-community';
	import { TrendDownIcon, TrendFlatIcon, TrendUpIcon } from '@nais/ds-svelte-community/icons';
	import type { VulnerabilitySummaryNewVariables } from './$houdini';

	interface Props {
		teamSlug: string;
	}

	let { teamSlug }: Props = $props();

	export const _VulnerabilitySummaryFinalVariables: VulnerabilitySummaryNewVariables = () => {
		return { team: teamSlug };
	};

	const vulnerabilities = graphql(`
		query VulnerabilitySummaryFinal($team: Slug!) @cache(policy: NetworkOnly) @load {
			team(slug: $team) {
				vulnerabilitySummary {
					critical
					riskScore
					bomCount
					coverage
					riskScoreTrend
					status {
						state
						title
						description
					}
				}
				workloads {
					pageInfo {
						totalCount
					}
				}
			}
		}
	`);

	let team = $derived($vulnerabilities.data?.team);
</script>

<div class="summary">
	<Heading size="small" level="2" spacing>Summary</Heading>
	{#if team}
		<div class="grid">
			<span
				style={team.vulnerabilitySummary.status.some((s) => s.state === 'COVERAGE_TOO_LOW')
					? 'color: var(--a-text-danger)'
					: 'color: inherit'}
				>{Math.round(
					(team.vulnerabilitySummary.bomCount / team.workloads.pageInfo.totalCount) * 100
				)}%</span
			>
			<div>
				{team.vulnerabilitySummary.bomCount} of {team.workloads.pageInfo.totalCount} workloads have SBOM
				<!-- (below defined threshold of 90%). -->
			</div>

			<span
				class="vulnerability-count"
				style:background-color={team.vulnerabilitySummary.critical
					? severityToColor({ severity: 'critical' })
					: undefined}>{team.vulnerabilitySummary.critical}</span
			>
			<div>Critical vulnerabilities</div>

			<div>
				{team.vulnerabilitySummary.riskScore}
			</div>
			<div>Total risk score</div>

			<div style:line-height="0">
				{#if team.vulnerabilitySummary.riskScoreTrend === TeamVulnerabilityRiskScoreTrend.UP}
					<TrendUpIcon style="color: var(--a-icon-danger);" font-size="50" />
				{:else if team.vulnerabilitySummary.riskScoreTrend === TeamVulnerabilityRiskScoreTrend.DOWN}
					<TrendDownIcon style="color: var(--a-icon-success);" font-size="50" />
				{:else}
					<TrendFlatIcon style="color: var(--a-icon-warning);" font-size="50" />
				{/if}
			</div>
			<div>Risk score trend</div>
		</div>
	{/if}
</div>

<style>
	.grid {
		display: grid;
		grid-template-columns: auto 1fr;
		column-gap: var(--a-spacing-4);
		row-gap: var(--a-spacing-6);
		align-items: center;

		> :nth-child(2n + 1) {
			font-size: 2rem;
			font-weight: 600;
			justify-self: center;
		}
	}

	.vulnerability-count {
		border-radius: 4px;
		padding: 4px 16px;
	}

	.summary {
		background-color: var(--a-surface-subtle);
		padding: var(--a-spacing-5);
		border-radius: 12px;
		justify-self: end;
	}
</style>
