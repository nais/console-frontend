<script lang="ts">
	import { graphql } from '$houdini';
	import VulnerabilitySummaryFinal from '$lib/components/VulnerabilitySummaryFinal.svelte';
	import type { VulnerabilityOverviewVariables } from './$houdini';

	interface Props {
		teamSlug: string;
	}

	let { teamSlug }: Props = $props();

	export const _VulnerabilityOverviewVariables: VulnerabilityOverviewVariables = () => {
		return { team: teamSlug };
	};

	const vulnerabilityOverview = graphql(`
		query VulnerabilityOverview($team: Slug!) @cache(policy: NetworkOnly) @load {
			team(slug: $team) {
				environments {
					id
					environment {
						name
					}
				}
				vulnerabilitySummary {
					bomCount
					coverage
					critical
					high
					low
					medium
					ranking
					riskScore
					riskScoreTrend
					unassigned
				}
				workloads(first: 600) {
					pageInfo {
						totalCount
					}
					nodes {
						id
						__typename
						name
						teamEnvironment {
							environment {
								name
							}
						}
						team {
							slug
						}
						status {
							errors {
								__typename
								# 		level
								# 		... on WorkloadStatusVulnerable {
								# 			summary {
								# 				riskScore
								# 				critical
								# 			}
								# 		}
								# 		... on WorkloadStatusMissingSBOM {
								# 			level
								# 		}
							}
						}
					}
				}
			}
		}
	`);

	const supportedErrorTypes = ['WorkloadStatusVulnerable'] as const;

	const getWorkloadsWithError = (errorType: (typeof supportedErrorTypes)[number]) => {
		const workloads = $vulnerabilityOverview.data?.team.workloads.nodes.filter((workload) =>
			workload.status.errors.some((error) => error.__typename === errorType)
		);
		if (workloads?.length) {
			return {
				__typename: errorType,
				level: workloads[0].status.errors.find((error) => error.__typename === errorType)?.level,
				workloads
			};
		} else {
			return {
				__typename: errorType
			};
		}
	};

	const team = $derived($vulnerabilityOverview.data?.team);
</script>

<div class="columns">
	<div class="status">
		{#if team}
			<div class="alerts-wrapper">
				<!-- {#each supportedErrorTypes.map(getWorkloadsWithError) as errors (errors.__typename)}
					{#if errors.workloads?.length && errors.level}
						<TeamErrorMessage
							collapsible={false}
							error={{
								__typename: errors.__typename,
								level: errors.level
							}}
							{teamSlug}
							workloads={errors.workloads}
						/>
					{/if}
				{/each} -->
			</div>

			<!-- <div class="media-object">
					<Nais
						size="80px"
						style="color: var(--a-icon-success)"
						aria-label="Team is nais"
						role="image"
					/>
					<div>
						<BodyShort spacing>
							<strong>Nais!</strong> Your team currently has no workloads with a risk score above 100
							and no critical vulnerabilities. This means your security posture is strong, and your dependencies
							are well-maintained.
						</BodyShort>
						<BodyShort>
							Keep up the good work in monitoring and updating your workloads to maintain this
							status!
						</BodyShort>
					</div>
				</div> -->
		{/if}
	</div>

	<VulnerabilitySummaryFinal {teamSlug} />
</div>

<style>
	.media-object {
		display: grid;
		grid-template-columns: auto 1fr;
		gap: var(--a-spacing-4);
		max-width: 75ch;
	}
	.status {
		display: grid;
		gap: var(--a-spacing-2);
	}
	.columns {
		display: grid;
		grid-template-columns: 1fr 350px;
		gap: 1rem;
		align-items: start;
	}
</style>
