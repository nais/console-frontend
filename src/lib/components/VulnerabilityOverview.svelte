<script lang="ts">
	import { fragment, graphql, type VulnerabilityOverviewFragment } from '$houdini';
	import Nais from '$lib/icons/Nais.svelte';
	import { BodyShort } from '@nais/ds-svelte-community';
	import TeamErrorMessage from './errors/TeamErrorMessage.svelte';
	import VulnerabilitySummaryFinal from './VulnerabilitySummaryFinal.svelte';

	interface Props {
		team: VulnerabilityOverviewFragment;
	}

	let { team }: Props = $props();

	let data = $derived(
		fragment(
			team,
			graphql(`
				fragment VulnerabilityOverviewFragment on Team {
					slug
					vulnerabilitySummary {
						bomCount
						coverage
						critical
						high
						low
						medium
						ranking
						riskScore
						riskScoreTrend
						unassigned
					}
					workloads(first: 999) {
						nodes {
							__typename
							id
							name
							team {
								slug
							}
							teamEnvironment {
								environment {
									name
								}
							}

							status {
								errors {
									level
									... on WorkloadStatusMissingSBOM {
										__typename
									}
									... on WorkloadStatusVulnerable {
										__typename
									}
								}
							}
						}
					}
				}
			`)
		)
	);

	const supportedErrorTypes = ['WorkloadStatusVulnerable', 'WorkloadStatusMissingSBOM'] as const;

	const getWorkloadsWithError = (errorType: (typeof supportedErrorTypes)[number]) => {
		const workloads = $data?.workloads.nodes.filter((workload) =>
			workload.status.errors.some((error) => error.__typename === errorType)
		);
		if (workloads?.length) {
			return {
				__typename: errorType,
				level: workloads[0].status.errors.find((error) => error.__typename === errorType)?.level,
				workloads
			};
		} else {
			return {
				__typename: errorType
			};
		}
	};
</script>

<div class="columns">
	<div class="status">
		<div class="alerts-wrapper">
			{#each supportedErrorTypes
				.map(getWorkloadsWithError)
				.filter((error) => error.workloads?.length && error.level) as errors (errors.__typename)}
				<TeamErrorMessage
					collapsible={false}
					error={{
						__typename: errors.__typename,
						level: errors.level ?? 'ERROR'
					}}
					teamSlug={$data.slug}
					workloads={errors.workloads ?? []}
				/>
			{:else}
				<div class="media-object">
					<Nais
						size="80px"
						style="color: var(--a-icon-success)"
						aria-label="Team is nais"
						role="image"
					/>
					<div>
						<BodyShort spacing>
							<strong>Nais!</strong> Your team currently has no workloads with a risk score above 100
							and no critical vulnerabilities. This means your security posture is strong, and your dependencies
							are well-maintained.
						</BodyShort>
						<BodyShort>
							Keep up the good work in monitoring and updating your workloads to maintain this
							status!
						</BodyShort>
					</div>
				</div>
			{/each}
		</div>
	</div>

	<VulnerabilitySummaryFinal teamSlug={$data.slug} />
</div>

<style>
	.alerts-wrapper {
		display: flex;
		flex-direction: column;
		gap: var(--a-spacing-2);
	}
	.media-object {
		padding: var(--a-spacing-2);
		display: grid;
		grid-template-columns: auto 1fr;
		gap: var(--a-spacing-4);
		max-width: 75ch;
	}
	.status {
		display: grid;
		gap: var(--a-spacing-2);
	}
	.columns {
		display: grid;
		grid-template-columns: 1fr 350px;
		gap: 1rem;
		align-items: start;
	}
</style>
