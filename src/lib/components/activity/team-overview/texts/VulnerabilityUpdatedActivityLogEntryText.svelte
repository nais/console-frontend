<script lang="ts">
	import type { TeamOverviewActivityLog$result } from '$houdini';
	import Time from '$lib/Time.svelte';
	import { BodyShort, ReadMore, Tag } from '@nais/ds-svelte-community';

	let {
		data
	}: {
		data: Extract<
			TeamOverviewActivityLog$result['team']['activityLog']['edges'][number]['node'],
			{ __typename: 'VulnerabilityUpdatedActivityLogEntry' }
		>;
	} = $props();

	// Helper function to format suppression state
	function formatSuppressionState(state: string): string {
		return state.toLowerCase().replace(/_/g, ' ');
	}

	// Helper function to get severity color
	function getSeverityVariant(severity: string): 'error' | 'warning' | 'info' | 'neutral' {
		switch (severity) {
			case 'CRITICAL':
				return 'error';
			case 'HIGH':
				return 'error';
			case 'MEDIUM':
				return 'warning';
			case 'LOW':
				return 'info';
			default:
				return 'neutral';
		}
	}

	// Helper function to get suppression state color
	function getSuppressionVariant(state: string): 'success' | 'warning' | 'info' | 'neutral' {
		switch (state) {
			case 'RESOLVED':
				return 'success';
			case 'FALSE_POSITIVE':
				return 'success';
			case 'NOT_AFFECTED':
				return 'success';
			case 'IN_TRIAGE':
				return 'warning';
			default:
				return 'neutral';
		}
	}

	let vuln = $derived(data.vulnerabilityUpdated);
</script>

<div>
	<BodyShort>
		Vulnerability <strong>{vuln.identifier}</strong> in package <strong>{vuln.package}</strong>
		for image <strong>{vuln.imageRef}</strong> was updated
	</BodyShort>

	<ReadMore header="Details" size="small">
		<div class="vulnerability-details">
			<dl>
				<dt>Severity:</dt>
				<dd>
					<Tag size="small" variant={getSeverityVariant(vuln.severity)}>
						{vuln.severity.toLowerCase()}
					</Tag>
				</dd>

				<dt>Status:</dt>
				<dd class="status-change">
					{#if vuln.previousSuppression}
						<Tag size="small" variant={getSuppressionVariant(vuln.previousSuppression.state)}>
							{formatSuppressionState(vuln.previousSuppression.state)}
						</Tag>
						<span class="arrow">â†’</span>
					{/if}
					{#if vuln.newSuppression}
						<Tag size="small" variant={getSuppressionVariant(vuln.newSuppression.state)}>
							{formatSuppressionState(vuln.newSuppression.state)}
						</Tag>
					{/if}
				</dd>

				{#if vuln.newSuppression && vuln.newSuppression.reason}
					<dt>Reason:</dt>
					<dd><code>{vuln.newSuppression.reason}</code></dd>
				{/if}

				<dt>Image:</dt>
				<dd><code class="image-ref">{vuln.imageRef}</code></dd>
			</dl>
		</div>
	</ReadMore>

	<BodyShort textColor="subtle" size="small">
		By {data.actor}
		<Time time={data.createdAt} distance />
	</BodyShort>
</div>

<style>
	.vulnerability-details {
		margin: 0.75rem 0;
		padding: 0.75rem;
		background-color: var(--ax-bg-subtle);
		border-radius: 0.375rem;
		border: 1px solid var(--ax-border-subtle);
	}

	dl {
		display: grid;
		grid-template-columns: max-content 1fr;
		gap: 0.5rem 1rem;
		margin: 0;
	}

	dt {
		font-weight: 500;
		color: var(--ax-text-default);
	}

	dd {
		margin: 0;
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.status-change {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.arrow {
		color: var(--ax-text-subtle);
		font-weight: bold;
	}

	code {
		font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
		background-color: var(--ax-bg-default);
		padding: 0.25rem 0.5rem;
		border-radius: 0.25rem;
		font-size: 0.875em;
		border: 1px solid var(--ax-border-subtle);
	}

	.image-ref {
		word-break: break-all;
		font-size: 0.8em;
		max-width: 100%;
		overflow-wrap: break-word;
	}
</style>
