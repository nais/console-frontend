<script lang="ts">
	import { envTagVariant } from '$lib/envTagVariant';
	import Time from '$lib/Time.svelte';
	import { BodyShort, ReadMore, Tag } from '@nais/ds-svelte-community';
	import { activityLogResourceLink } from '../../utils';
	import type { ActivityLogEntry } from './types';

	let {
		data
	}: {
		data: ActivityLogEntry<'VulnerabilityUpdatedActivityLogEntry'>;
	} = $props();

	const vuln = $derived(data.vulnerabilityUpdated);
	const hasStateChange = $derived(vuln?.previousSuppression?.state !== vuln?.newSuppression?.state);
	const hasReasonChange = $derived(
		vuln?.newSuppression?.reason !== vuln?.previousSuppression?.reason
	);
	const isNewSuppression = $derived(
		vuln?.newSuppression?.state && !vuln?.previousSuppression?.state
	);
	const isUnsuppressed = $derived(vuln?.previousSuppression?.state && !vuln?.newSuppression?.state);
	const isStateChange = $derived(vuln?.newSuppression?.state && vuln?.previousSuppression?.state);

	const link = $derived(
		activityLogResourceLink(
			data.environmentName ?? '',
			data.resourceType,
			data.resourceName,
			data.teamSlug
		)
	);

	function getSeverityClass(severity: string | undefined | null): string {
		if (!severity) return '';
		const normalized = severity.toLowerCase();
		const validSeverities = ['critical', 'high', 'medium', 'low'];
		return validSeverities.includes(normalized) ? `severity-${normalized}` : '';
	}
</script>

<div>
	{#if vuln}
		{#if hasStateChange}
			{#if isNewSuppression}
				Suppressed vulnerability in image
			{:else if isUnsuppressed}
				Unsuppressed vulnerability in image
			{:else if isStateChange}
				Changed vulnerability suppression in image
			{:else}
				Updated vulnerability in image
			{/if}
		{:else if hasReasonChange}
			Updated vulnerability suppression reason in image
		{:else}
			Updated vulnerability in image
		{/if}
		<a href={link}>{data.resourceName}</a>
		{#if data.environmentName}
			in <Tag size="small" variant={envTagVariant(data.environmentName)}>{data.environmentName}</Tag
			>
		{/if}

		<ReadMore header="Vulnerability details" size="small">
			<div class="vulnerability-details">
				<p><strong>Identifier:</strong> {vuln.identifier}</p>
				<p><strong>Package:</strong> {vuln.package}</p>
				{#if vuln.severity}
					<p>
						<strong>Severity:</strong>
						<span class="vulnerability-severity {getSeverityClass(vuln.severity)}"
							>{vuln.severity}</span
						>
					</p>
				{/if}
				{#if hasStateChange}
					{#if vuln.previousSuppression?.state}
						<p>
							<strong>Previous state:</strong>
							{vuln.previousSuppression.state.replace('_', ' ').toLowerCase()}
						</p>
					{/if}
					{#if vuln.newSuppression?.state}
						<p>
							<strong>New state:</strong>
							{vuln.newSuppression.state.replace('_', ' ').toLowerCase()}
						</p>
					{/if}
				{/if}
				{#if vuln.newSuppression?.reason}
					<p><strong>Reason:</strong> {vuln.newSuppression.reason}</p>
				{/if}
			</div>
		</ReadMore>

		<BodyShort textColor="subtle" size="small">
			By {data.actor}
			<Time time={data.createdAt} distance />
		</BodyShort>
	{:else}
		Updated vulnerability in image
		<a href={link}>{data.resourceName}</a>
		{#if data.environmentName}
			in <Tag size="small" variant={envTagVariant(data.environmentName)}>{data.environmentName}</Tag
			>
		{/if}

		<BodyShort textColor="subtle" size="small">
			By {data.actor}
			<Time time={data.createdAt} distance />
		</BodyShort>
	{/if}
</div>

<style>
	.vulnerability-severity {
		font-size: 0.75rem;
		font-weight: 600;
		padding: 0.125rem 0.375rem;
		border-radius: 0.25rem;
		text-transform: uppercase;
		margin-left: 0.5rem;
	}

	.vulnerability-severity.severity-critical {
		background-color: var(--ax-bg-danger);
		color: var(--ax-text-on-danger);
	}

	.vulnerability-severity.severity-high {
		background-color: var(--ax-bg-warning);
		color: var(--ax-text-on-warning);
	}

	.vulnerability-severity.severity-medium {
		background-color: var(--ax-bg-info);
		color: var(--ax-text-on-info);
	}

	.vulnerability-severity.severity-low {
		background-color: var(--ax-bg-subtle);
		color: var(--ax-text-subtle);
	}

	.vulnerability-details {
		margin-top: 0.5rem;
	}

	.vulnerability-details p {
		margin: 0.25rem 0;
		font-size: 0.875rem;
	}
</style>
