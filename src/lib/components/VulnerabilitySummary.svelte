<script lang="ts">
	import { graphql, PendingValue } from '$houdini';
	import VulnerabilityBadge from '$lib/icons/VulnerabilityBadge.svelte';
	import { percentageFormatter } from '$lib/utils/formatters';
	import { severityToColor } from '$lib/utils/vulnerabilities';
	import { Button, HelpText, Skeleton, Tooltip } from '@nais/ds-svelte-community';
	import type { VulnerabilitiesSummaryVariables } from './$houdini';

	export let teamName: string;

	export const _VulnerabilitiesSummaryVariables: VulnerabilitiesSummaryVariables = () => {
		return { team: teamName };
	};

	const vulnerabilities = graphql(`
		query VulnerabilitiesSummary($team: Slug!) @cache(policy: NetworkOnly) @load {
			team(slug: $team) @loading(cascade: true) {
				id
				slug
				apps {
					pageInfo {
						totalCount
					}
				}
				naisjobs {
					pageInfo {
						totalCount
					}
				}
				vulnerabilitiesSummary {
					critical
					high
					low
					medium
					riskScore
					unassigned
					bomCount
					coverage
				}
			}
		}
	`);

	$: team = $vulnerabilities.data?.team;
</script>

<h4>Vulnerabilities</h4>
{#if team}
	<div style="place-content: center; display: flex;">
		{#if team.vulnerabilitiesSummary.critical !== PendingValue}
			<Button as="a" variant="tertiary-neutral" size="small" href="/team/{teamName}/applications">
				<Tooltip placement="right" content="severity: CRITICAL">
					<VulnerabilityBadge
						text={String(team.vulnerabilitiesSummary.critical)}
						color={severityToColor('critical')}
						size={'66px'}
					/>
				</Tooltip>
			</Button>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
	</div>
	<div class="vulnerabilities">
		{#if team.vulnerabilitiesSummary.high !== PendingValue}
			<Tooltip placement="right" content="severity: HIGH">
				<VulnerabilityBadge
					text={String(team.vulnerabilitiesSummary.high)}
					color={severityToColor('high')}
					size={'38px'}
				/>
			</Tooltip>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
		{#if team.vulnerabilitiesSummary.medium !== PendingValue}
			<Tooltip placement="right" content="severity: MEDIUM">
				<VulnerabilityBadge
					text={String(team.vulnerabilitiesSummary.medium)}
					color={severityToColor('medium')}
					size={'38px'}
				/>
			</Tooltip>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
		{#if team.vulnerabilitiesSummary.low !== PendingValue}
			<Tooltip placement="right" content="severity: LOW">
				<VulnerabilityBadge
					text={String(team.vulnerabilitiesSummary.low)}
					color={severityToColor('low')}
					size={'38px'}
				/>
			</Tooltip>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
		{#if team.vulnerabilitiesSummary.unassigned !== PendingValue}
			<Tooltip placement="right" content="severity: UNASSIGNED">
				<VulnerabilityBadge
					text={String(team.vulnerabilitiesSummary.unassigned)}
					color={severityToColor('unassigned')}
					size={'38px'}
				/>
			</Tooltip>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
	</div>

	{#if team.vulnerabilitiesSummary.coverage !== PendingValue}
		<p class="container">
			Coverage
			<span class="container">
				<span class={team.vulnerabilitiesSummary.coverage < 100 ? 'red' : 'green'}
					>{percentageFormatter(
						team.vulnerabilitiesSummary.coverage ? team.vulnerabilitiesSummary.coverage : 0,
						0
					)}</span
				>

				<HelpText title="SBOM coverage"
					>The percentage of images with a documented list of dependencies, known as a Software Bill
					of Materials (SBOM), is crucial for effectively monitoring vulnerabilities within the
					workload. Red indicates that less than 100% of the workloads have an SBOM.
				</HelpText>
			</span>
		</p>
	{:else}
		<Skeleton variant="text" width="250px" />
	{/if}
	{#if team.vulnerabilitiesSummary.riskScore !== PendingValue}
		<p class="container">
			Risk score
			<span class="container">
				<span class={team.vulnerabilitiesSummary.riskScore > 100 ? 'red' : 'green'}
					>{team.vulnerabilitiesSummary.riskScore}</span
				>
				<HelpText title="Risk score"
					>The risk score is a calculated value based on the severity of the vulnerabilities
					discovered within the workloads. A higher risk score indicates a higher risk of
					exploitation.
				</HelpText>
			</span>
		</p>
	{:else}
		<Skeleton variant="text" width="250px" />
	{/if}
{/if}

<style>
	.vulnerabilities {
		display: flex;
		gap: 0.5rem;
		margin-top: 0.8rem;
		justify-content: space-evenly;
	}

	.container {
		display: flex;
		gap: 0.5rem;
		justify-content: space-between;
	}

	.red {
		color: var(--a-surface-danger);
	}

	.green {
		color: var(--a-surface-success);
	}
</style>
