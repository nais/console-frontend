<script lang="ts">
	import { PendingValue, graphql } from '$houdini';
	import VulnerabilityBadge from '$lib/icons/VulnerabilityBadge.svelte';
	import { percentageFormatter } from '$lib/utils/formatters';
	import { severityToColor } from '$lib/utils/vulnerabilities';
	import { HelpText, Skeleton, Tooltip } from '@nais/ds-svelte-community';
	import type { VulnerabilitiesSummaryVariables } from './$houdini';

	export let teamName: string;

	export const _VulnerabilitiesSummaryVariables: VulnerabilitiesSummaryVariables = () => {
		return { team: teamName };
	};

	const vulnerabilities = graphql(`
		query VulnerabilitiesSummary($team: Slug!) @cache(policy: NetworkOnly) @load {
			team(slug: $team) @loading(cascade: true) {
				id
				slug
				apps {
					pageInfo {
						totalCount
					}
				}
				vulnerabilitiesSummary {
					critical
					high
					low
					medium
					riskScore
					total
					unassigned
					bomCount
				}
			}
		}
	`);
</script>

<h4>Vulnerabilities</h4>
{#if $vulnerabilities.data}
	<div class="container">
		{#if $vulnerabilities.data.team && $vulnerabilities.data.team.vulnerabilitiesSummary.critical !== PendingValue}
			<Tooltip placement="right" content="severity: CRITICAL">
				<VulnerabilityBadge
					text={String($vulnerabilities.data?.team.vulnerabilitiesSummary.critical)}
					color={severityToColor('critical')}
					size={'38px'}
				/></Tooltip
			>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
		{#if $vulnerabilities.data.team && $vulnerabilities.data.team.vulnerabilitiesSummary.high !== PendingValue}
			<Tooltip placement="right" content="severity: HIGH">
				<VulnerabilityBadge
					text={String($vulnerabilities.data?.team.vulnerabilitiesSummary.high)}
					color={severityToColor('high')}
					size={'38px'}
				/></Tooltip
			>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
		{#if $vulnerabilities.data.team && $vulnerabilities.data.team.vulnerabilitiesSummary.medium !== PendingValue}
			<Tooltip placement="right" content="severity: MEDIUM">
				<VulnerabilityBadge
					text={String($vulnerabilities.data?.team.vulnerabilitiesSummary.medium)}
					color={severityToColor('medium')}
					size={'38px'}
				/></Tooltip
			>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
		{#if $vulnerabilities.data.team && $vulnerabilities.data.team.vulnerabilitiesSummary.low !== PendingValue}
			<Tooltip placement="right" content="severity: LOW">
				<VulnerabilityBadge
					text={String($vulnerabilities.data?.team.vulnerabilitiesSummary.low)}
					color={severityToColor('low')}
					size={'38px'}
				/></Tooltip
			>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
		{#if $vulnerabilities.data.team && $vulnerabilities.data.team.vulnerabilitiesSummary.unassigned !== PendingValue}
			<Tooltip placement="right" content="severity: UNASSIGNED">
				<VulnerabilityBadge
					text={String($vulnerabilities.data?.team.vulnerabilitiesSummary.unassigned)}
					color={severityToColor('unassigned')}
					size={'38px'}
				/></Tooltip
			>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
	</div>

	<p class="risk-score">
		{#if $vulnerabilities.data.team.vulnerabilitiesSummary.riskScore !== PendingValue && $vulnerabilities.data.team.apps.pageInfo.totalCount !== PendingValue}
			Average risk score: {$vulnerabilities.data?.team.vulnerabilitiesSummary.bomCount === 0
				? 'NA'
				: (
						$vulnerabilities.data?.team.vulnerabilitiesSummary.riskScore /
						$vulnerabilities.data?.team.vulnerabilitiesSummary.bomCount
					).toLocaleString('en-GB', { maximumFractionDigits: 2 })}
			<HelpText title="Risk score"
				>Risk score is calculated based on the number of vulnerabilities and their severity. Average
				is calculated for apps with SBOM.</HelpText
			>
		{:else}
			<Skeleton variant="text" width="250px" />
		{/if}
	</p>
	<p class="risk-score">
		{#if $vulnerabilities.data.team.vulnerabilitiesSummary.bomCount !== PendingValue && $vulnerabilities.data.team.apps.pageInfo.totalCount !== PendingValue}
			Coverage: {percentageFormatter(
				($vulnerabilities.data?.team.vulnerabilitiesSummary.bomCount /
					$vulnerabilities.data?.team.apps.pageInfo.totalCount) *
					100
			)}
			<HelpText title="Risk score">Coverage is the percentage of apps with SBOM for team.</HelpText>
		{:else}
			<Skeleton variant="text" width="250px" />
		{/if}
	</p>
	<a href="/team/{teamName}/vulnerabilities">View all vulnerabilities</a>
{/if}

<style>
	.container {
		display: flex;
		gap: 0.5rem;
	}
	.risk-score {
		display: flex;
		gap: 0.5rem;
	}
</style>
