<script lang="ts">
	import { PendingValue, graphql } from '$houdini';
	import VulnerabilityBadge from '$lib/icons/VulnerabilityBadge.svelte';
	import { percentageFormatter } from '$lib/utils/formatters';
	import { severityToColor } from '$lib/utils/vulnerabilities';
	import { HelpText, Skeleton, Tooltip } from '@nais/ds-svelte-community';
	import type { VulnerabilitiesSummaryVariables } from './$houdini';

	export let teamName: string;

	export const _VulnerabilitiesSummaryVariables: VulnerabilitiesSummaryVariables = () => {
		return { team: teamName };
	};

	const vulnerabilities = graphql(`
		query VulnerabilitiesSummary($team: Slug!) @cache(policy: NetworkOnly) @load {
			team(slug: $team) @loading(cascade: true) {
				id
				slug
				apps {
					pageInfo {
						totalCount
					}
				}
				vulnerabilitiesSummary {
					critical
					high
					low
					medium
					riskScore
					total
					unassigned
					bomCount
				}
			}
		}
	`);

	$: team = $vulnerabilities.data?.team;
</script>

<h4>Vulnerabilities</h4>
{#if team}
	<div class="container">
		{#if team.vulnerabilitiesSummary.critical !== PendingValue}
			<Tooltip placement="right" content="severity: CRITICAL">
				<VulnerabilityBadge
					text={String(team.vulnerabilitiesSummary.critical)}
					color={severityToColor('critical')}
					size={'38px'}
				/></Tooltip
			>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
		{#if team.vulnerabilitiesSummary.high !== PendingValue}
			<Tooltip placement="right" content="severity: HIGH">
				<VulnerabilityBadge
					text={String(team.vulnerabilitiesSummary.high)}
					color={severityToColor('high')}
					size={'38px'}
				/></Tooltip
			>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
		{#if team.vulnerabilitiesSummary.medium !== PendingValue}
			<Tooltip placement="right" content="severity: MEDIUM">
				<VulnerabilityBadge
					text={String(team.vulnerabilitiesSummary.medium)}
					color={severityToColor('medium')}
					size={'38px'}
				/></Tooltip
			>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
		{#if team.vulnerabilitiesSummary.low !== PendingValue}
			<Tooltip placement="right" content="severity: LOW">
				<VulnerabilityBadge
					text={String(team.vulnerabilitiesSummary.low)}
					color={severityToColor('low')}
					size={'38px'}
				/></Tooltip
			>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
		{#if team.vulnerabilitiesSummary.unassigned !== PendingValue}
			<Tooltip placement="right" content="severity: UNASSIGNED">
				<VulnerabilityBadge
					text={String(team.vulnerabilitiesSummary.unassigned)}
					color={severityToColor('unassigned')}
					size={'38px'}
				/></Tooltip
			>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
	</div>

	{#if team.vulnerabilitiesSummary.bomCount !== PendingValue && team.apps.pageInfo.totalCount !== PendingValue}
		{@const coverage = (team.vulnerabilitiesSummary.bomCount / team.apps.pageInfo.totalCount) * 100}

		<p class="container">
			Coverage:
			<span class={coverage < 100 ? 'red' : 'green'}>{percentageFormatter(coverage, 0)}</span>
			<HelpText title="SBOM coverage"
				>The percentage of applications with a documented list of dependencies (SBOM). We need an
				SBOM to monitor vulnerabilities within the application.
			</HelpText>
		</p>
	{:else}
		<Skeleton variant="text" width="250px" />
	{/if}
	<a href="/team/{teamName}/vulnerabilities">View all vulnerabilities</a>
{/if}

<style>
	.container {
		display: flex;
		gap: 0.5rem;
	}

	.red {
		color: var(--a-surface-danger);
	}

	.green {
		color: var(--a-surface-success);
	}
</style>
