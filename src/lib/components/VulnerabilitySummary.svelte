<script lang="ts">
	import { graphql, PendingValue } from '$houdini';
	import VulnerabilityBadge from '$lib/icons/VulnerabilityBadge.svelte';
	import { percentageFormatter } from '$lib/utils/formatters';
	import { severityToColor } from '$lib/utils/vulnerabilities';
	import { Button, HelpText, Skeleton, Tooltip } from '@nais/ds-svelte-community';
	import type { VulnerabilitySummaryVariables } from './$houdini';

	interface Props {
		teamName: string;
	}

	let { teamName }: Props = $props();

	export const _VulnerabilitySummaryVariables: VulnerabilitySummaryVariables = () => {
		return { team: teamName };
	};

	const vulnerabilities = graphql(`
		query VulnerabilitySummary($team: Slug!) @cache(policy: NetworkOnly) @load {
			team(slug: $team) @loading(cascade: true) {
				vulnerabilitySummary {
					critical
					high
					low
					medium
					riskScore
					unassigned
					bomCount
					coverage
				}
			}
		}
	`);

	let team = $derived($vulnerabilities.data?.team);
</script>

<h4>Vulnerabilities</h4>
{#if team}
	<div style="place-content: center; display: flex;">
		{#if team.vulnerabilitySummary.critical !== PendingValue}
			<Button
				as="a"
				variant="tertiary-neutral"
				size="small"
				href="/team/{teamName}/vulnerabilities"
			>
				<Tooltip placement="right" content="severity: CRITICAL">
					<VulnerabilityBadge
						text={String(team.vulnerabilitySummary.critical)}
						color={severityToColor('critical')}
						size={'66px'}
					/>
				</Tooltip>
			</Button>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
	</div>
	<div class="vulnerabilities">
		{#if team.vulnerabilitySummary.high !== PendingValue}
			<Tooltip placement="right" content="severity: HIGH">
				<VulnerabilityBadge
					text={String(team.vulnerabilitySummary.high)}
					color={severityToColor('high')}
					size={'38px'}
				/>
			</Tooltip>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
		{#if team.vulnerabilitySummary.medium !== PendingValue}
			<Tooltip placement="right" content="severity: MEDIUM">
				<VulnerabilityBadge
					text={String(team.vulnerabilitySummary.medium)}
					color={severityToColor('medium')}
					size={'38px'}
				/>
			</Tooltip>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
		{#if team.vulnerabilitySummary.low !== PendingValue}
			<Tooltip placement="right" content="severity: LOW">
				<VulnerabilityBadge
					text={String(team.vulnerabilitySummary.low)}
					color={severityToColor('low')}
					size={'38px'}
				/>
			</Tooltip>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
		{#if team.vulnerabilitySummary.unassigned !== PendingValue}
			<Tooltip placement="right" content="severity: UNASSIGNED">
				<VulnerabilityBadge
					text={String(team.vulnerabilitySummary.unassigned)}
					color={severityToColor('unassigned')}
					size={'38px'}
				/>
			</Tooltip>
		{:else}
			<Skeleton variant="circle" width="38px" height="38px" />
		{/if}
	</div>

	{#if team.vulnerabilitySummary.coverage !== PendingValue}
		<p class="container">
			Coverage
			<span class="container">
				<span class={team.vulnerabilitySummary.coverage < 100 ? 'red' : 'green'}
					>{percentageFormatter(
						team.vulnerabilitySummary.coverage ? team.vulnerabilitySummary.coverage : 0,
						0
					)}</span
				>

				<HelpText title="SBOM coverage"
					>The percentage of images with a documented list of dependencies, known as a Software Bill
					of Materials (SBOM), is crucial for effectively monitoring vulnerabilities within the
					workload. Red indicates that less than 100% of the workloads have an SBOM.
				</HelpText>
			</span>
		</p>
	{:else}
		<Skeleton variant="text" width="250px" />
	{/if}
	{#if team.vulnerabilitySummary.riskScore !== PendingValue}
		<p class="container">
			Risk score
			<span class="container">
				<span class={team.vulnerabilitySummary.riskScore > 100 ? 'red' : 'green'}
					>{team.vulnerabilitySummary.riskScore}</span
				>
				<HelpText title="Risk score"
					>The risk score is a calculated value based on the severity of the vulnerabilities
					discovered within the workloads. A higher risk score indicates a higher risk of
					exploitation. Algorithms may vary, but a common approach is to assign a score based on the
					severity of the vulnerabilities found. The Score is calculated: "((critical * 10) + (high
					* 5) + (medium * 3) + (low * 1) + (unassigned * 5))".
				</HelpText>
			</span>
		</p>
	{:else}
		<Skeleton variant="text" width="250px" />
	{/if}
{/if}

<style>
	.vulnerabilities {
		display: flex;
		gap: 0.5rem;
		margin-top: 0.8rem;
		justify-content: space-evenly;
	}

	.container {
		display: flex;
		gap: 0.5rem;
		justify-content: space-between;
	}

	.red {
		color: var(--a-surface-danger);
	}

	.green {
		color: var(--a-surface-success);
	}
</style>
