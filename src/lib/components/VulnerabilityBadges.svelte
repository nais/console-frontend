<script lang="ts">
	import { PendingValue } from '$houdini';
	import { percentageFormatter } from '$lib/utils/formatters';
	import { severityToColor } from '$lib/utils/vulnerabilities';

	import { BodyShort, Loader, Tooltip } from '@nais/ds-svelte-community';

	type VulnerabilitySummary =
		| {
				critical: number;
				high: number;
				medium: number;
				low: number;
				unassigned: number;
				riskScore?: number;
				coverage?: number;
		  }
		| typeof PendingValue;

	interface Props {
		summary: VulnerabilitySummary;
	}

	let { summary }: Props = $props();

	const categories = ['critical', 'high', 'medium', 'low', 'unassigned'] as const;
</script>

<div class="vulnerability-summary">
	{#if summary !== PendingValue}
		{#each categories as category (category)}
			<Tooltip content={category}>
				<BodyShort
					class="vulnerability-count"
					style="background-color: {severityToColor(category)}"
				>
					{summary[category]}
				</BodyShort>
			</Tooltip>
		{/each}
	{:else}
		<Loader />
	{/if}
</div>
{#if summary !== PendingValue}
	<div class="container">
		<dl>
			{#if summary['riskScore']}
				<dt>Risk score:</dt>
				<dd>
					<span class={summary['riskScore'] > 100 ? 'red' : 'green'}>{summary['riskScore']}</span>
				</dd>
				<!--HelpText title="Risk score"
				>The risk score is a calculated value based on the severity of the vulnerabilities
				discovered within the workloads. A higher risk score indicates a higher risk of
				exploitation. Algorithms may vary, but a common approach is to assign a score based on the
				severity of the vulnerabilities found. The Score is calculated: "((critical * 10) + (high *
				5) + (medium * 3) + (low * 1) + (unassigned * 5))".
			</HelpText-->
			{/if}

			{#if summary['coverage']}
				<dt>Coverage:</dt>
				<dd>
					<span class={summary['coverage'] < 100 ? 'red' : 'green'}
						>{percentageFormatter(summary['coverage'] ? summary['coverage'] : 0, 0)}</span
					>
				</dd>
			{/if}
		</dl>
	</div>
{/if}

<style>
	.vulnerability-summary {
		display: flex;
		gap: 1px;

		:global(:first-child > .vulnerability-count) {
			border-top-left-radius: 4px;
			border-bottom-left-radius: 4px;
		}

		:global(:last-child > .vulnerability-count) {
			border-top-right-radius: 4px;
			border-bottom-right-radius: 4px;
		}

		:global(.vulnerability-count) {
			padding: 4px 10px;
		}
	}

	.container {
		display: flex;
		gap: 0.5rem;
		justify-content: space-between;
	}

	.red {
		color: var(--a-surface-danger);
	}

	.green {
		color: var(--a-surface-success);
	}

	dl {
		display: grid;
		grid-template-columns: 90px auto;
		margin-block-start: 0;
		margin-block-end: 0;
		padding-top: var(--a-spacing-4);
	}

	dt {
		font-weight: bold;
		text-align: left;
	}

	dd {
		margin: 0;
	}
</style>
