<script lang="ts">
	import { docURL } from '$lib/doc';
	import SuccessIcon from '$lib/icons/SuccessIcon.svelte';
	import WarningIcon from '$lib/icons/WarningIcon.svelte';
	import { BodyShort, Heading, Link } from '@nais/ds-svelte-community';
	import VulnerabilityBadges from './VulnerabilityBadges.svelte';

	interface Props {
		workload: {
			__typename: string;
			name: string;
			team: {
				slug: string;
			};
			teamEnvironmnet: {
				environment: {
					name: string;
				};
			};
			image: {
				hasSBOM: boolean;
				vulnerabilitySummary: {
					critical: number;
					high: number;
					medium: number;
					low: number;
					unassigned: number;
					riskScore: number;
				};
			};
		};
	}

	const { workload }: Props = $props();

	const { image } = workload;

	const imageDetailsUrl = $derived(
		`/team/${workload.team.slug}/${workload.teamEnvironmnet.environment.name}/${workload.__typename === 'Application' ? 'app' : 'job'}/${workload.name}/vulnerability-report`
	);

	const categories = ['critical', 'high', 'medium', 'low', 'unassigned'] as const;
	const hasFindings = categories.some(
		(severity) => (image.vulnerabilitySummary?.[severity] ?? 0) > 0
	);
</script>

<div class="wrapper">
	<Heading level="3" size="small">Vulnerabilities</Heading>

	{#if !image.hasSBOM && image.vulnerabilitySummary !== null}
		<BodyShort>
			<WarningIcon class="text-aligned-icon" /> Data was discovered, but the SBOM was not rendered. Refer
			to the <Link href={docURL('/services/vulnerabilities/')}>Nais documentation</Link> for further
			assistance.
		</BodyShort>
	{:else if image.vulnerabilitySummary === null}
		<BodyShort>
			<WarningIcon class="text-aligned-icon" /> No data found.
			<a href={docURL('/services/vulnerabilities/how-to/sbom/')} target="_blank">How to fix</a>
		</BodyShort>
	{:else if image.hasSBOM && image.vulnerabilitySummary && hasFindings}
		<VulnerabilityBadges summary={image.vulnerabilitySummary} />
	{:else if image.hasSBOM}
		<BodyShort>
			<SuccessIcon class="text-aligned-icon" /> No vulnerabilities found. Good work!
		</BodyShort>
	{/if}

	<Link href={imageDetailsUrl}>View vulnerability report</Link>
</div>

<style>
	.wrapper {
		display: flex;
		flex-direction: column;
		gap: var(--a-spacing-1);
		align-items: start;
	}
</style>
