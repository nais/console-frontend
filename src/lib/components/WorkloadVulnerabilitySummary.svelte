<script lang="ts">
	import { docURL } from '$lib/doc';
	import WarningIcon from '$lib/icons/WarningIcon.svelte';
	import { BodyShort, Link } from '@nais/ds-svelte-community';
	import VulnerabilityBadges from './VulnerabilityBadges.svelte';

	interface Props {
		showReportLink?: boolean;
		workload: {
			__typename: string | null;
			name: string;
			team: {
				slug: string;
			};
			teamEnvironment: {
				environment: {
					name: string;
				};
			};
			image: {
				hasSBOM: boolean;
				vulnerabilitySummary: {
					critical: number;
					high: number;
					medium: number;
					low: number;
					unassigned: number;
					riskScore: number;
				} | null;
			};
		};
	}

	const { workload, showReportLink = true }: Props = $props();

	const { image } = workload;

	const imageDetailsUrl = $derived(
		`/team/${workload.team.slug}/${workload.teamEnvironment.environment.name}/${workload.__typename === 'Application' ? 'app' : 'job'}/${workload.name}/vulnerability-report`
	);
</script>

<div class="wrapper">
	{#if image.hasSBOM && image.vulnerabilitySummary}
		<VulnerabilityBadges summary={image.vulnerabilitySummary} />
		{#if showReportLink}
			<Link href={imageDetailsUrl}>View vulnerability report</Link>
		{/if}
	{:else}
		<BodyShort>
			<WarningIcon class="text-aligned-icon" /> No vulnerability data available. Learn how to generate
			SBOMs and attestations for your workloads in the
			<a href={docURL('/services/vulnerabilities/how-to/sbom/')} target="_blank"
				>Nais documentation
			</a>.
		</BodyShort>
	{/if}
</div>

<style>
	.wrapper {
		display: flex;
		flex-direction: column;
		gap: var(--a-spacing-1);
		align-items: start;
	}
</style>
