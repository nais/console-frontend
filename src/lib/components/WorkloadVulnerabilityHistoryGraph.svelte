<script lang="ts">
	import { page } from '$app/state';
	import { graphql } from '$houdini';
	import EChart from '$lib/chart/EChart.svelte';
	import { transformVulnerabilities } from '$lib/chart/transformVulnerabilities';
	import {
		BodyLong,
		Heading,
		Loader,
		ToggleGroup,
		ToggleGroupItem
	} from '@nais/ds-svelte-community';
	import { subDays, subMonths } from 'date-fns';
	import type { WorkloadVulnerabilityHistoryVariables } from './$houdini';

	interface Props {
		team: string;
		environment: string;
		workload: string;
	}

	let { team, environment, workload }: Props = $props();

	const getFrom = (interval: string): Date => {
		const now = new Date();
		switch (interval) {
			case '6m':
				return subMonths(now, 6);
			case '30d':
				return subDays(now, 30);
			case '7d':
				return subDays(now, 7);
			default:
				return subDays(now, 7);
		}
	};

	const intervalOptions = ['6m', '30d', '7d'];

	let interval = $state(page.url.searchParams.get('interval') ?? '7d');

	export const _WorkloadVulnerabilityHistoryVariables: WorkloadVulnerabilityHistoryVariables =
		() => {
			return {
				team: team,
				env: environment,
				workload: workload,
				from: getFrom(interval)
			};
		};

	const query = graphql(`
		query WorkloadVulnerabilityHistory(
			$team: Slug!
			$env: String!
			$workload: String!
			$from: Date!
		) @load {
			team(slug: $team) {
				environment(name: $env) {
					workload(name: $workload) {
						name
						imageVulnerabilityHistory(from: $from) {
							samples {
								date
								summary {
									critical
									high
									medium
									low
									unassigned
								}
							}
						}
					}
				}
			}
		}
	`);

	let riskScoreToggle = $state('off');

	let options = $derived(
		transformVulnerabilities(
			$query.data?.team.environment.workload.imageVulnerabilityHistory,
			riskScoreToggle === 'on'
		)
	);
</script>

<div class="graph">
	<div class="heading">
		<div class="content">
			<Heading level="2" spacing
				>Vulnerability History for <strong
					>{$query.data?.team.environment.workload.name} - Is this the right comp?</strong
				></Heading
			>
			<BodyLong>
				This stacked line chart displays the accumulation of image vulnerabilities over time,
				categorized by severity level. Use the interval selector to adjust the time range. Enable
				the Risk Score toggle to weight each severity by its impact.
			</BodyLong>
		</div>
	</div>
	{#if !$query.fetching}
		<div class="toggles">
			<ToggleGroup label="Interval" value={interval} onchange={(i) => (interval = i)}>
				{#each intervalOptions as interval (interval)}
					<ToggleGroupItem value={interval}>{interval}</ToggleGroupItem>
				{/each}
			</ToggleGroup>
			<ToggleGroup
				label="Risk score"
				value={riskScoreToggle}
				onchange={(val) => (riskScoreToggle = val)}
			>
				<ToggleGroupItem value="off">Off</ToggleGroupItem>
				<ToggleGroupItem value="on">On</ToggleGroupItem>
			</ToggleGroup>
		</div>
		<EChart {options} style="height: 500px" />
	{:else}
		<div style="display: flex; justify-content: center; align-items: center; height: 500px;">
			<Loader size="3xlarge" />
		</div>
	{/if}
</div>

<style>
	.graph {
		grid-column: 1 / -1;
		display: flex;
		flex-direction: column;
	}

	.heading {
		display: flex;
		justify-content: space-between;
		align-items: flex-end;
		gap: var(--spacing-layout);
		padding-bottom: var(--spacing-layout);
	}

	.content {
		max-width: 80ch;
	}
	.toggles {
		display: flex;
		gap: var(--spacing-layout);
		flex-direction: row;
		justify-content: flex-end;
	}
</style>
