<script lang="ts">
	import { page } from '$app/state';
	import { graphql, OrderDirection, WorkloadOrderField } from '$houdini';
	import Pagination from '$lib/Pagination.svelte';
	import Time from '$lib/Time.svelte';
	import { changeParams } from '$lib/utils/searchparams';
	import { BodyShort, Button, Detail, Tooltip } from '@nais/ds-svelte-community';
	import { ActionMenu, ActionMenuCheckboxItem } from '@nais/ds-svelte-community/experimental';
	import { CheckmarkIcon, ChevronDownIcon } from '@nais/ds-svelte-community/icons';
	import List from '../list/List.svelte';
	import ListItem from '../list/ListItem.svelte';
	import OrderByMenu, { urlToOrderDirection, urlToOrderField } from '../OrderByMenu.svelte';
	import WorkloadLink from '../WorkloadLink.svelte';

	interface Props {
		team: string;
		[key: string]: unknown;
	}

	let { team }: Props = $props();

	const query = graphql(`
		query WorkloadsWithSbom(
			$team: Slug!
			$orderBy: WorkloadOrder
			$filter: TeamWorkloadsFilter
			$after: Cursor
			$before: Cursor
			$first: Int
			$last: Int
		) {
			team(slug: $team) {
				slug
				environments {
					environment {
						id
						name
					}
				}
				workloads(
					first: $first
					last: $last
					orderBy: $orderBy
					filter: $filter
					after: $after
					before: $before
				) @paginate(mode: SinglePage) {
					pageInfo {
						totalCount
						pageStart
						pageEnd
						hasNextPage
						hasPreviousPage
						startCursor
						endCursor
					}
					nodes {
						__typename
						id
						name
						teamEnvironment {
							environment {
								name
							}
						}
						team {
							slug
						}
						image {
							name
							tag
							hasSBOM
							vulnerabilitySummary {
								critical
								high
								medium
								low
								unassigned
								riskScore
								lastUpdated
							}
						}
					}
				}
			}
		}
	`);

	const metadata = graphql(`
		query WorkloadsWithSbomMetadata($team: Slug!) {
			team(slug: $team) {
				environments {
					environment {
						id
						name
					}
				}
				workloads {
					pageInfo {
						totalCount
					}
				}
			}
		}
	`);

	$effect.pre(() => {
		const env: string[] = page.url.searchParams.get('environments')?.split(',') || [];
		const field = urlToOrderField(
			WorkloadOrderField,
			WorkloadOrderField.VULNERABILITY_RISK_SCORE,
			page.url
		);
		const direction = urlToOrderDirection(page.url, OrderDirection.DESC);
		query.fetch({
			variables: {
				team,
				orderBy: {
					field,
					direction
				},
				filter: { environments: env },
				after: page.url.searchParams.get('after') || null,
				first: page.url.searchParams.get('after') ? 20 : null,
				before: page.url.searchParams.get('before') || null,
				last: page.url.searchParams.get('before') ? 20 : null
			}
		});
		metadata.fetch({ variables: { team } });
	});

	const totalWorkloads = $derived($metadata.data?.team.workloads.pageInfo.totalCount ?? 0);

	const allEnvs = $derived(
		$metadata.data?.team.environments.map((env) => env.environment.name) ?? []
	);

	let filteredEnvs = $derived(page.url.searchParams.get('environments')?.split(',') ?? allEnvs);

	$effect(() => {
		const environments = filteredEnvs.length === allEnvs.length ? '' : filteredEnvs.join(',');

		if (environments !== (page.url.searchParams.get('environments') ?? '')) {
			changeQuery({ environments });
		}
	});

	const changeQuery = (
		params: {
			newFilter?: string;
			environments?: string;
			after?: string;
			before?: string;
		} = {}
	) => {
		changeParams(
			{
				environments: params.environments ?? '',
				after: params.after ?? '',
				before: params.before ?? ''
			},
			{ noScroll: true }
		);
	};

	const vulnerabilityReportUrl = (workload: {
		readonly __typename: string | null;
		readonly id: string;
		readonly name: string;
		readonly teamEnvironment: {
			readonly environment: {
				readonly name: string;
			};
		};
		readonly team: {
			readonly slug: string;
		};
	}) => {
		return `/team/${workload.team.slug}/${workload.teamEnvironment.environment.name}/${workload.__typename === 'Application' ? 'app' : 'job'}/${workload.name}/vulnerability-report`;
	};
</script>

{#if totalWorkloads > 0}
	{@const team = $query.data?.team}
	<List title="Workloads with Vulnerabilities">
		{#snippet menu()}
			<ActionMenu>
				{#snippet trigger(props)}
					<Button
						variant="tertiary-neutral"
						size="small"
						iconPosition="right"
						{...props}
						icon={ChevronDownIcon}
					>
						<span style="font-weight: normal">Environment</span>
					</Button>
				{/snippet}
				<ActionMenuCheckboxItem
					checked={$query.data?.team.environments.every((env) =>
						filteredEnvs.includes(env.environment.name)
					)
						? true
						: filteredEnvs.length > 0
							? 'indeterminate'
							: false}
					onchange={(checked) => (filteredEnvs = checked ? allEnvs : [])}
				>
					All environments
				</ActionMenuCheckboxItem>
				{#each $query.data?.team.environments ?? [] as { environment } (environment.id)}
					<ActionMenuCheckboxItem
						checked={filteredEnvs.includes(environment.name)}
						onchange={(checked) =>
							(filteredEnvs = checked
								? [...filteredEnvs, environment.name]
								: filteredEnvs.filter((env) => env !== environment.name))}
					>
						{environment.name}
					</ActionMenuCheckboxItem>
				{/each}
			</ActionMenu>
			<OrderByMenu
				orderField={WorkloadOrderField}
				defaultOrderField={WorkloadOrderField.VULNERABILITY_RISK_SCORE}
				onlyInclude={[
					WorkloadOrderField.VULNERABILITY_RISK_SCORE,
					WorkloadOrderField.VULNERABILITY_LAST_SCANNED,
					WorkloadOrderField.VULNERABILITY_SEVERITY_CRITICAL,
					WorkloadOrderField.VULNERABILITY_SEVERITY_HIGH,
					WorkloadOrderField.VULNERABILITY_SEVERITY_MEDIUM,
					WorkloadOrderField.VULNERABILITY_SEVERITY_LOW,
					WorkloadOrderField.VULNERABILITY_SEVERITY_UNASSIGNED,
					WorkloadOrderField.HAS_SBOM,
					WorkloadOrderField.NAME
				]}
			/>
		{/snippet}

		{#each team?.workloads.nodes ?? [] as workload (workload.id)}
			<ListItem>
				<WorkloadLink {workload} />
				<div class="right">
					<div class="grid">
						{#if workload.image.hasSBOM}
							<div class="vulnerability">
								<div class="vulnerability-summary">
									<Tooltip content="Critical">
										{#if workload.image.hasSBOM && workload.image.vulnerabilitySummary}
											{#if workload.image.vulnerabilitySummary.critical > 0}
												<a
													href={vulnerabilityReportUrl(workload)}
													class="vulnerability-count CRITICAL"
												>
													{workload.image.vulnerabilitySummary
														? workload.image.vulnerabilitySummary.critical
														: '-'}
												</a>
											{:else}
												<CheckmarkIcon
													style="color: var(--ax-text-success-decoration); font-size: 1.75rem;"
												/>
											{/if}
										{:else}
											-
										{/if}
									</Tooltip>
								</div>
							</div>
							<div class="vulnerability">
								<div class="vulnerability-summary">
									<Tooltip content="High">
										{#if workload.image.hasSBOM && workload.image.vulnerabilitySummary}
											{#if workload.image.hasSBOM && workload.image.vulnerabilitySummary.high > 0}
												<a href={vulnerabilityReportUrl(workload)} class="vulnerability-count HIGH">
													{workload.image.vulnerabilitySummary.high}
												</a>
											{:else}
												<CheckmarkIcon
													style="color: var(--ax-text-success-decoration); font-size: 1.75rem;"
												/>
											{/if}
										{:else}
											-
										{/if}
									</Tooltip>
								</div>
							</div>
							<div class="vulnerability">
								<div class="vulnerability-summary">
									<Tooltip content="Medium">
										{#if workload.image.hasSBOM && workload.image.vulnerabilitySummary}
											{#if workload.image.vulnerabilitySummary.medium > 0}
												<a
													href={vulnerabilityReportUrl(workload)}
													class="vulnerability-count MEDIUM"
												>
													{workload.image.vulnerabilitySummary
														? workload.image.vulnerabilitySummary.medium
														: '-'}
												</a>
											{:else}
												<CheckmarkIcon
													style="color: var(--ax-text-success-decoration); font-size: 1.75rem;"
												/>
											{/if}
										{:else}
											-
										{/if}
									</Tooltip>
								</div>
							</div>
							<div class="vulnerability">
								<div class="vulnerability-summary">
									<Tooltip content="Low">
										{#if workload.image.hasSBOM && workload.image.vulnerabilitySummary}
											{#if workload.image.vulnerabilitySummary.low > 0}
												<a href={vulnerabilityReportUrl(workload)} class="vulnerability-count LOW">
													{workload.image.vulnerabilitySummary
														? workload.image.vulnerabilitySummary.low
														: '-'}
												</a>
											{:else}
												<CheckmarkIcon
													style="color: var(--ax-text-success-decoration); font-size: 1.75rem;"
												/>
											{/if}
										{:else}
											-
										{/if}
									</Tooltip>
								</div>
							</div>
							<div class="vulnerability">
								<div class="vulnerability-summary">
									<Tooltip content="Unassigned">
										{#if workload.image.hasSBOM && workload.image.vulnerabilitySummary}
											{#if workload.image.vulnerabilitySummary.unassigned > 0}
												<a
													href={vulnerabilityReportUrl(workload)}
													class="vulnerability-count UNASSIGNED"
												>
													{workload.image.vulnerabilitySummary.unassigned}
												</a>
											{:else}
												<CheckmarkIcon
													style="color: var(--ax-text-success-decoration); font-size: 1.75rem;"
												/>
											{/if}
										{:else}
											-
										{/if}
									</Tooltip>
								</div>
							</div>
							<div class="vulnerability">
								<div class="vulnerability-summary">
									<Tooltip content="Risk score">
										<BodyShort class="vulnerability-count">
											<Detail
												>Risk Score:<a
													href={vulnerabilityReportUrl(workload)}
													class="vulnerability-count RISK_SCORE"
												>
													{workload.image.vulnerabilitySummary && workload.image.hasSBOM
														? workload.image.vulnerabilitySummary.riskScore
														: '-'}
												</a></Detail
											>
										</BodyShort>
									</Tooltip>
								</div>
							</div>
							{#if workload.image.vulnerabilitySummary && workload.image.vulnerabilitySummary.lastUpdated}
								<Detail
									>Last scanned: <Time
										time={workload.image.vulnerabilitySummary.lastUpdated}
										distance
										short
									/></Detail
								>
							{/if}
						{:else}
							<div class="no-sbom">
								<Detail>This workload has no registered Software Bill of Materials (SBOM).</Detail>
							</div>
						{/if}
					</div>
				</div>
			</ListItem>
		{/each}
	</List>

	<div>
		<Pagination
			page={$query.data?.team.workloads.pageInfo}
			loaders={{
				loadPreviousPage: () => {
					console.log('loadPreviousPage');
					changeQuery({
						before: $query.data?.team.workloads.pageInfo.startCursor ?? '',
						after: ''
					});
				},
				loadNextPage: () => {
					console.log('loadNextPage');
					changeQuery({
						after: $query.data?.team.workloads.pageInfo.endCursor ?? '',
						before: ''
					});
				}
			}}
		/>
	</div>
{/if}

<style>
	.vulnerability-summary {
		display: flex;
		gap: 1px;

		.vulnerability-count {
			border-top-left-radius: 4px;
			border-bottom-left-radius: 4px;

			border-top-right-radius: 4px;
			border-bottom-right-radius: 4px;

			padding: 4px 10px;

			color: inherit;
			text-decoration: none;

			&.CRITICAL {
				background-color: var(--ax-danger-600);
				&:hover {
					background-color: var(--ax-danger-500);
				}
			}
			&.HIGH {
				background-color: color-mix(in oklab, var(--ax-danger-600), var(--ax-warning-200));
				&:hover {
					background-color: color-mix(in oklab, var(--ax-danger-500), var(--ax-warning-100));
				}
			}
			&.MEDIUM {
				background-color: var(--ax-warning-300);
				&:hover {
					background-color: var(--ax-warning-200);
				}
			}
			&.LOW {
				background-color: var(--ax-success-400);
				&:hover {
					background-color: var(--ax-success-300);
				}
			}
			&.UNASSIGNED {
				background-color: var(--ax-neutral-200);
				&:hover {
					background-color: var(--ax-neutral-100);
				}
			}

			&.RISK_SCORE {
				&:hover {
					background-color: var(--ax-neutral-100);
				}
			}
		}
	}
	.vulnerability {
		display: flex;
		align-items: center;
		justify-content: center;
	}
	.grid {
		display: grid;
		grid-template-columns: repeat(5, 88px) 160px 160px;
		gap: var(--ax-space-8);
		align-items: center;
	}

	.no-sbom {
		grid-column: 1 / -1;
		display: flex;
		align-items: center;
	}
	.right {
		display: flex;
		flex-direction: row;
		align-items: end;
		gap: var(--ax-space-24);
	}
</style>
