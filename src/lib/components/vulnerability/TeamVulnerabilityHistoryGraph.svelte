<script lang="ts">
	import { graphql } from '$houdini';
	import VulnerabilityChart from '$lib/chart/VulnerabilityChart.svelte';
	import {
		getFrom,
		intervalOptionsVulnerabilityHistory
	} from '$lib/components/vulnerability/dateUtils';
	import {
		BodyLong,
		Heading,
		Loader,
		ToggleGroup,
		ToggleGroupItem
	} from '@nais/ds-svelte-community';

	interface Props {
		teamSlug: string;
	}

	let { teamSlug: team }: Props = $props();

	let interval: (typeof intervalOptionsVulnerabilityHistory)[number] = $state('7d');

	const query = graphql(`
		query TeamVulnerabilityHistory($team: Slug!, $from: Date!) {
			team(slug: $team) {
				slug
				imageVulnerabilityHistory(from: $from) {
					samples {
						date
						summary {
							critical
							high
							low
							medium
							unassigned
						}
					}
				}
			}
		}
	`);

	$effect.pre(() => {
		query.fetch({
			variables: {
				team: team,
				from: getFrom(interval)
			}
		});
	});

	let riskScoreToggle = $state(false);
</script>

<div class="graph">
	<div class="heading">
		<div class="content">
			<Heading level="2" spacing
				>Vulnerability History for <strong>{$query.data?.team.slug}</strong></Heading
			>
			<BodyLong>
				This stacked line chart displays the accumulation of image vulnerabilities over time,
				categorized by severity level. Use the interval selector to adjust the time range. Enable
				the Risk Score toggle to weight each severity by its impact.
			</BodyLong>
		</div>
	</div>
	{#if !$query.fetching}
		<div class="toggles">
			<ToggleGroup label="Interval" bind:value={interval}>
				{#each intervalOptionsVulnerabilityHistory as interval (interval)}
					<ToggleGroupItem value={interval}>{interval}</ToggleGroupItem>
				{/each}
			</ToggleGroup>
			<ToggleGroup
				label="Risk score"
				value={riskScoreToggle ? 'on' : 'off'}
				onchange={(val) => (riskScoreToggle = val === 'on')}
			>
				<ToggleGroupItem value="off">Off</ToggleGroupItem>
				<ToggleGroupItem value="on">On</ToggleGroupItem>
			</ToggleGroup>
		</div>
		{#if $query.data?.team.imageVulnerabilityHistory}
			<div class="h-[500px]">
				<VulnerabilityChart
					data={$query.data?.team.imageVulnerabilityHistory}
					isRiskScore={riskScoreToggle}
					{interval}
				/>
			</div>
		{:else}
			<BodyLong size="large" spacing
				>No vulnerability history data available for this team.</BodyLong
			>
		{/if}
	{:else}
		<div style="display: flex; justify-content: center; align-items: center; min-height: 500px;">
			<Loader size="3xlarge" />
		</div>
	{/if}
</div>

<style>
	.graph {
		display: flex;
		flex-direction: column;
	}

	.heading {
		display: flex;
		justify-content: space-between;
		align-items: flex-end;
		gap: var(--spacing-layout);
	}

	.content {
		max-width: 80ch;
	}

	.toggles {
		display: flex;
		gap: var(--spacing-layout);
		flex-direction: row;
		justify-content: flex-end;
	}
</style>
