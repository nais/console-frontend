<script lang="ts">
	import { PendingValue } from '$houdini';
	import Time from '$lib/Time.svelte';
	import { percentageFormatter } from '$lib/utils/formatters';
	import { severityToColor } from '$lib/utils/vulnerabilities';

	import { BodyShort, Loader } from '@nais/ds-svelte-community';

	type VulnerabilitySummary =
		| {
				critical: number;
				high: number;
				medium: number;
				low: number;
				unassigned: number;
				riskScore?: number;
				coverage?: number;
				lastUpdated?: Date | null;
		  }
		| typeof PendingValue;

	interface Props {
		summary: VulnerabilitySummary;
	}

	let { summary }: Props = $props();

	const categories = ['critical', 'high', 'medium', 'low', 'unassigned'] as const;
</script>

<div class="wrapper">
	{#if summary !== PendingValue && summary['lastUpdated']}
		<div class="last-updated">
			Last updated <Time time={summary['lastUpdated']} distance />
		</div>
	{/if}
	<div class="vulnerability-summary">
		{#if summary !== PendingValue}
			{#each categories as category (category)}
				<BodyShort
					class="vulnerability-count"
					style="background-color: {severityToColor({ severity: category })}"
				>
					{summary[category]}
				</BodyShort>
				<div class="category">{category}</div>
			{/each}
		{:else}
			<Loader />
		{/if}
	</div>
</div>
<div style="margin-top: var(--ax-space-16);">
	{#if summary !== PendingValue && summary['riskScore']}
		<BodyShort>
			<strong>Risk score:</strong>
			{#if summary['riskScore'] > 100}
				<span class="red">{summary['riskScore']}</span> (above defined threshold of 100)
			{:else}
				<span class="green">{summary['riskScore']}</span>
			{/if}
		</BodyShort>
	{/if}
	{#if summary !== PendingValue && summary['coverage']}
		<BodyShort>
			<strong>SBOM coverage:</strong>
			{#if summary['coverage'] < 100}
				<span class="red">{percentageFormatter(summary['coverage'], 0)}</span> (below defined threshold
				of 100%)
			{:else}
				<span class="green">{percentageFormatter(summary['coverage'], 0)}</span>
			{/if}
		</BodyShort>
	{/if}
</div>

<style>
	.wrapper {
		display: grid;
		row-gap: var(--ax-space-8);
	}
	.category {
		text-transform: capitalize;
	}

	.vulnerability-summary {
		display: grid;
		grid-template-columns: auto 1fr;
		align-items: center;
		column-gap: var(--ax-space-8);
		row-gap: 1px;

		:global(.vulnerability-count:first-of-type) {
			border-top-left-radius: 4px;
			border-top-right-radius: 4px;
		}

		:global(.vulnerability-count:last-of-type) {
			border-bottom-right-radius: 4px;
			border-bottom-left-radius: 4px;
		}

		:global(.vulnerability-count) {
			padding: 4px 10px;
			text-align: center;
		}
	}

	.red {
		color: var(--ax-bg-danger-strong);
	}

	.green {
		color: var(--ax-text-success-subtle);
	}

	.last-updated {
		grid-column: span 2;
		color: var(--ax-text-info-subtle);
		font-size: 0.9rem;
	}
</style>
