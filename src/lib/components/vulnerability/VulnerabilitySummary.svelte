<script lang="ts">
	import { page } from '$app/state';
	import { TeamVulnerabilityRiskScoreTrend, type ValueOf } from '$houdini';
	import Time from '$lib/Time.svelte';
	import { numberFormatter, percentageFormatter } from '$lib/utils/formatters';
	import { severityToColor } from '$lib/utils/vulnerabilities';
	import { Heading, Loader } from '@nais/ds-svelte-community';
	import { TrendDownIcon, TrendFlatIcon, TrendUpIcon } from '@nais/ds-svelte-community/icons';

	const {
		teamSlug,
		vulnerabilitySummary,
		workloads
	}: {
		teamSlug: string;
		vulnerabilitySummary:
			| {
					sbomCount: number;
					coverage: number;
					critical: number;
					riskScore: number;
					riskScoreTrend: ValueOf<typeof TeamVulnerabilityRiskScoreTrend>;
					lastUpdated: Date | null;
			  }
			| undefined
			| null;
		workloads:
			| {
					pageInfo: {
						totalCount: number;
					};
			  }
			| undefined
			| null;
	} = $props();
</script>

<div class="wrapper">
	<Heading size="small" level="2">Vulnerability Summary</Heading>
	{#if vulnerabilitySummary && vulnerabilitySummary !== undefined && workloads && workloads !== undefined}
		{#if vulnerabilitySummary.lastUpdated}
			<div class="last-updated">
				Last updated <Time time={vulnerabilitySummary.lastUpdated} distance />
			</div>
		{/if}

		<div class="grid">
			<span
				style={vulnerabilitySummary.coverage < 90
					? 'color: var(--ax-text-danger)'
					: 'color: inherit'}>{percentageFormatter(vulnerabilitySummary.coverage, 0)}</span
			>
			<div>
				{numberFormatter(vulnerabilitySummary.sbomCount)} of {numberFormatter(
					workloads.pageInfo.totalCount
				)}
				workloads have SBOM
			</div>

			<span
				class="vulnerability-count"
				style:background-color={vulnerabilitySummary.critical
					? severityToColor({ severity: 'critical' })
					: undefined}>{numberFormatter(vulnerabilitySummary.critical)}</span
			>
			<div>Critical vulnerabilities</div>

			<div>
				{numberFormatter(vulnerabilitySummary.riskScore)}
			</div>
			<div>Total risk score</div>

			<div style:line-height="0">
				{#if vulnerabilitySummary.riskScoreTrend === TeamVulnerabilityRiskScoreTrend.UP}
					<TrendUpIcon style="color: var(--ax-text-danger-decoration);" font-size="50" />
				{:else if vulnerabilitySummary.riskScoreTrend === TeamVulnerabilityRiskScoreTrend.DOWN}
					<TrendDownIcon style="color: var(--ax-text-success-decoration);" font-size="50" />
				{:else}
					<TrendFlatIcon style="color: var(--ax-text-warning-decoration);" font-size="50" />
				{/if}
			</div>
			<div>30-day trend</div>
		</div>
	{:else}
		<div style="display: flex; justify-content: center; align-items: center; margin-top: 100px;">
			<Loader size="3xlarge" />
		</div>
	{/if}

	{#if page.url.pathname.split('/')[3] !== 'vulnerabilities'}
		<a href="/team/{teamSlug}/vulnerabilities" style:margin-top="auto" style:align-self="end"
			>View Team Vulnerabilities</a
		>
	{/if}
</div>

<style>
	.grid {
		display: grid;
		grid-template-columns: auto 1fr;
		column-gap: var(--ax-space-16);
		row-gap: var(--ax-space-24);
		align-items: center;
		padding-top: var(--ax-space-16);
		padding-bottom: var(--ax-space-16);

		> :nth-child(2n + 1) {
			font-size: 2rem;
			font-weight: 600;
			justify-self: center;
		}
	}

	.vulnerability-count {
		border-radius: 4px;
		padding: 4px 16px;
	}

	.wrapper {
		display: flex;
		flex-direction: column;
		background-color: var(--ax-bg-sunken);
		padding: var(--ax-space-20);
		border-radius: 12px;
	}
	.last-updated {
		grid-column: span 2;
		color: var(--ax-text-info-subtle);
		font-size: 0.9rem;
	}
</style>
