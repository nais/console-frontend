<script lang="ts">
	import { TeamVulnerabilityRiskScoreTrend, type ValueOf } from '$houdini';
	import { numberFormatter, percentageFormatter } from '$lib/utils/formatters';
	import { severityToColor } from '$lib/utils/vulnerabilities';
	import { Heading } from '@nais/ds-svelte-community';
	import { TrendDownIcon, TrendFlatIcon, TrendUpIcon } from '@nais/ds-svelte-community/icons';

	const {
		vulnerabilitySummary,
		workloads
	}: {
		vulnerabilitySummary: {
			bomCount: number;
			coverage: number;
			critical: number;
			riskScore: number;
			riskScoreTrend: ValueOf<typeof TeamVulnerabilityRiskScoreTrend>;
		};
		workloads: {
			pageInfo: {
				totalCount: number;
			};
		};
	} = $props();
</script>

<div class="summary">
	<Heading size="small" level="2" spacing>Vulnerability Summary</Heading>
	<div class="grid">
		<span
			style={vulnerabilitySummary.coverage < 90 ? 'color: var(--ax-text-danger)' : 'color: inherit'}
			>{percentageFormatter(vulnerabilitySummary.coverage, 0)}</span
		>
		<div>
			{numberFormatter(vulnerabilitySummary.bomCount)} of {numberFormatter(
				workloads.pageInfo.totalCount
			)}
			workloads have SBOM
		</div>

		<span
			class="vulnerability-count"
			style:background-color={vulnerabilitySummary.critical
				? severityToColor({ severity: 'critical' })
				: undefined}>{numberFormatter(vulnerabilitySummary.critical)}</span
		>
		<div>Critical vulnerabilities</div>

		<div>
			{numberFormatter(vulnerabilitySummary.riskScore)}
		</div>
		<div>Total risk score</div>

		<div style:line-height="0">
			{#if vulnerabilitySummary.riskScoreTrend === TeamVulnerabilityRiskScoreTrend.UP}
				<TrendUpIcon style="color: var(--ax-text-danger-icon);" font-size="50" />
			{:else if vulnerabilitySummary.riskScoreTrend === TeamVulnerabilityRiskScoreTrend.DOWN}
				<TrendDownIcon style="color: var(--ax-text-success-decoration);" font-size="50" />
			{:else}
				<TrendFlatIcon style="color: var(--ax-text-warning-icon);" font-size="50" />
			{/if}
		</div>
		<div>Risk score trend</div>
	</div>
</div>

<style>
	.grid {
		display: grid;
		grid-template-columns: auto 1fr;
		column-gap: var(--ax-space-16);
		row-gap: var(--ax-space-24);
		align-items: center;

		> :nth-child(2n + 1) {
			font-size: 2rem;
			font-weight: 600;
			justify-self: center;
		}
	}

	.vulnerability-count {
		border-radius: 4px;
		padding: 4px 16px;
	}

	.summary {
		background-color: var(--ax-bg-sunken);
		padding: var(--ax-space-20);
		border-radius: 12px;
	}
</style>
