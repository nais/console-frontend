<script lang="ts">
	import { page } from '$app/state';
	import { docURL } from '$lib/doc';
	import WarningIcon from '$lib/icons/WarningIcon.svelte';
	import { BodyShort } from '@nais/ds-svelte-community';
	import ExternalLink from '../ExternalLink.svelte';
	import VulnerabilityBadges from './VulnerabilityBadges.svelte';

	interface Props {
		workload: {
			__typename: string | null;
			name: string;
			team: {
				slug: string;
			};
			teamEnvironment: {
				environment: {
					name: string;
				};
			};
			image: {
				hasSBOM: boolean;
				vulnerabilitySummary: {
					critical: number;
					high: number;
					medium: number;
					low: number;
					unassigned: number;
					riskScore: number;
					lastUpdated: Date;
				} | null;
			};
		};
	}

	const { workload }: Props = $props();

	const { image } = workload;

	const imageDetailsUrl = $derived(
		`/team/${workload.team.slug}/${workload.teamEnvironment.environment.name}/${workload.__typename === 'Application' ? 'app' : 'job'}/${workload.name}/vulnerability-report`
	);
</script>

<div class="wrapper">
	{#if image.hasSBOM && image.vulnerabilitySummary}
		<VulnerabilityBadges summary={image.vulnerabilitySummary} />
		{#if page.url.pathname !== imageDetailsUrl}
			<a href={imageDetailsUrl}>View vulnerability report</a>
		{/if}
	{:else}
		<BodyShort>
			<WarningIcon class="text-aligned-icon" /> No vulnerability data available. Learn how to generate
			SBOMs and attestations for your workloads in the
			<ExternalLink href={docURL('/services/vulnerabilities/how-to/sbom/')}
				>Nais documentation
			</ExternalLink>.
		</BodyShort>
	{/if}
</div>

<style>
	.wrapper {
		display: flex;
		flex-direction: column;
		gap: var(--ax-space-4);
		align-items: start;
	}
</style>
